<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Linux è™šæ‹Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜ | Memos</title>
<meta name=keywords content><meta name=description content="æœ€è¿‘çœ‹äº†ã€ŠUnderstanding the LinuxÂ® Virtual Memory Managerã€‹é‡Œé¢çš„ç¬¬åäºŒç«  SHARED MEMORY VIRTUAL FILESYSTEM ï¼Œå¯¹æ–‡ä»¶ç³»ç»Ÿä»¥åŠå†…å­˜æ–‡ä»¶ç®¡ç†æœ‰äº†æ›´åŠ æ·±å…¥çš„äº†è§£ï¼Œä¸‹é¢æ˜¯çœ‹äº†è¿™ä¸€ç« èŠ‚ä¹‹åå¯¹å…¶ä¸­ä¸€äº›æ¦‚å¿µçš„ç†è§£ä»¥åŠæ‹“å±•ï¼Œè¦æ˜¯æƒ³äº†è§£è¿™ä¸€ç« ï¼Œå»ºè®®è¯»åŸæ–‡ï¼Œé…åˆè¿™ç¯‡åšå®¢è¾…åŠ©ç†è§£
Linux å“²å­¦

åœ¨ Linux é‡Œé¢ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½å¯ä»¥çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œå‡¡æ˜¯æ–‡ä»¶ï¼Œéƒ½åº”è¯¥æ”¯æŒæˆ–è€…æ¥è¿‘POSIXæ–‡ä»¶æ“ä½œï¼ˆæ¯”å¦‚ read() ï¼Œwrite() ï¼Œopen()ï¼‰
æ¯ä¸€å—å†…å­˜å¯¹è±¡ï¼Œéƒ½å¯ä»¥è¢«çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€æ—¦èµ‹äºˆè¿™å—å†…å­˜å¯¹è±¡ç›¸å¯¹åº”çš„æ–‡ä»¶æè¿°ï¼Œå°±å¯ä»¥ä½¿ç”¨åƒä½¿ç”¨æ™®é€šæ–‡ä»¶é‚£æ ·å­æ“ä½œå†…å­˜å¯¹è±¡
è€Œè¿™ä¹Ÿæ­£æ˜¯ VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ virtual file system ï¼ŒåŒ…æ‹¬å†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜ç®¡ç†ç³»ç»Ÿï¼‰çš„è®¾è®¡ç†å¿µä»¥åŠå®ç°æ–¹å‘

VMAï¼ˆvirtual memory areaï¼‰


Linux å†…æ ¸ç”¨vm_area_structç»“æ„ä½“æè¿°æŸä¸€æ®µè¿ç»­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ VMAï¼ˆvirtual memory areaï¼‰ï¼Œæ¯ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸ VMA éƒ½æœ‰è‡ªå·±çš„vm_area_struct ç»“æ„ä½“


å†…å­˜æè¿°ç¬¦ mm_struct æŒ‡å‘è¿›ç¨‹çš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œvm_area_struct åªæ˜¯æŒ‡å‘äº†è™šæ‹Ÿç©ºé—´çš„ä¸€æ®µï¼Œè¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸVMAçš„åœ°å€èŒƒå›´ä¸º [vm_start, vm_end) ï¼Œå·¦å¼€å³é—­



vm_area_struct æ˜¯ç”±åŒå‘é“¾è¡¨é“¾æ¥èµ·æ¥çš„ï¼Œå®ƒä»¬æ˜¯æŒ‰ç…§è™šæ‹Ÿåœ°å€é™åºæ’åºçš„ï¼Œæ¯ä¸ªè¿™æ ·çš„ç»“æ„éƒ½å¯¹åº”æè¿°ä¸€ä¸ªåœ°å€ç©ºé—´èŒƒå›´


ä¸ºäº†å¿«é€Ÿæ ¹æ®åœ°å€æ‰¾åˆ°å¯¹åº”çš„ VMAï¼Œå†…æ ¸å¯¹å…¶å»ºç«‹äº†çº¢é»‘æ ‘ç´¢å¼•ï¼Œçº¢é»‘æ ‘çš„æ¯ä¸ªå¶å­ç»“ç‚¹å°±æ˜¯ä¸€ä¸ªVMAåŒºåŸŸï¼Œå¼•å…¥çº¢é»‘æ ‘çš„å¥½å¤„æ˜¯å¯ä»¥æé«˜æŸ¥æ‰¾VMAçš„æ•ˆç‡ï¼ˆå³ä¾¿VMAçš„æ•°é‡ç¿»å€ï¼ŒVMAçš„æŸ¥æ‰¾æ¬¡æ•°ä¹Ÿåªå¢åŠ ä¸€æ¬¡ï¼‰

    
    
    
        
    




ä¹‹æ‰€ä»¥é€šè¿‡ VMA åˆ†éš”å†…å­˜åŒºåŸŸæ˜¯å› ä¸ºæ¯ä¸ªè™šæ‹ŸåŒºé—´å¯èƒ½æ¥æºä¸åŒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå¯æ‰§è¡Œæ˜ åƒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå…±äº«åº“ï¼Œè€Œæœ‰çš„å¯èƒ½æ˜¯åŠ¨æ€å†…å­˜åˆ†é…çš„å†…å­˜åŒºï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸ªç”± vm_area_struct ç»“æ„æ‰€æè¿°çš„åŒºé—´çš„å¤„ç†æ“ä½œå’Œå®ƒå‰åèŒƒå›´çš„å¤„ç†æ“ä½œä¸åŒï¼Œå› æ­¤ linux æŠŠè™šæ‹Ÿå†…å­˜åˆ†å‰²ç®¡ç†ï¼Œå¹¶åˆ©ç”¨äº†è™šæ‹Ÿå†…å­˜å¤„ç†ä¾‹ç¨‹ vm_ops æ¥æŠ½è±¡å¯¹ä¸åŒæ¥æºè™šæ‹Ÿå†…å­˜çš„å¤„ç†æ–¹æ³•


ä¸åŒçš„è™šæ‹ŸåŒºé—´å…¶å¤„ç†æ“ä½œå¯èƒ½ä¸åŒï¼Œlinux åœ¨è¿™é‡Œåˆ©ç”¨äº†é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œå³æŠŠä¸€ä¸ªè™šæ‹ŸåŒºé—´çœ‹æˆæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨ vm_area_struct æè¿°è¿™ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå…¶ä¸­çš„ vm_operation ç»“æ„æè¿°äº†åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„æ“ä½œ

    
    
    
        
    




è™šæ‹Ÿå†…å­˜ç©ºé—´ç®¡ç†æ¦‚æ‹¬å›¾

    
    
    
        
    

"><meta name=author content="HCY"><link rel=canonical href=https://hcy-asleep.github.io/Linux-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%BB%A5%E5%8F%8A%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.bf546705000388ff8f0176e72d11be7c3d4efd591a0430f9c62915164a160ae2.css integrity="sha256-v1RnBQADiP+PAXbnLRG+fD1O/VkaBDD5xikVFkoWCuI=" rel="preload stylesheet" as=style><link rel=icon href=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/hcy_site_favicon.png><link rel=icon type=image/png sizes=16x16 href=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/hcy_site_favicon.png><link rel=icon type=image/png sizes=32x32 href=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/hcy_site_favicon.png><link rel=apple-touch-icon href=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/hcy_site_favicon.png><link rel=mask-icon href=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/hcy_site_favicon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://hcy-asleep.github.io/Linux-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%BB%A5%E5%8F%8A%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><style>@media screen and (min-width:1px){.post-content input[type=checkbox]:checked~label>img{transform:scale(1.6);cursor:zoom-out;position:relative;z-index:999}.post-content img.zoomCheck{transition:transform .15s ease;z-index:999;cursor:zoom-in}}</style><meta property="og:title" content="Linux è™šæ‹Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜"><meta property="og:description" content="æœ€è¿‘çœ‹äº†ã€ŠUnderstanding the LinuxÂ® Virtual Memory Managerã€‹é‡Œé¢çš„ç¬¬åäºŒç«  SHARED MEMORY VIRTUAL FILESYSTEM ï¼Œå¯¹æ–‡ä»¶ç³»ç»Ÿä»¥åŠå†…å­˜æ–‡ä»¶ç®¡ç†æœ‰äº†æ›´åŠ æ·±å…¥çš„äº†è§£ï¼Œä¸‹é¢æ˜¯çœ‹äº†è¿™ä¸€ç« èŠ‚ä¹‹åå¯¹å…¶ä¸­ä¸€äº›æ¦‚å¿µçš„ç†è§£ä»¥åŠæ‹“å±•ï¼Œè¦æ˜¯æƒ³äº†è§£è¿™ä¸€ç« ï¼Œå»ºè®®è¯»åŸæ–‡ï¼Œé…åˆè¿™ç¯‡åšå®¢è¾…åŠ©ç†è§£
Linux å“²å­¦

åœ¨ Linux é‡Œé¢ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½å¯ä»¥çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œå‡¡æ˜¯æ–‡ä»¶ï¼Œéƒ½åº”è¯¥æ”¯æŒæˆ–è€…æ¥è¿‘POSIXæ–‡ä»¶æ“ä½œï¼ˆæ¯”å¦‚ read() ï¼Œwrite() ï¼Œopen()ï¼‰
æ¯ä¸€å—å†…å­˜å¯¹è±¡ï¼Œéƒ½å¯ä»¥è¢«çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€æ—¦èµ‹äºˆè¿™å—å†…å­˜å¯¹è±¡ç›¸å¯¹åº”çš„æ–‡ä»¶æè¿°ï¼Œå°±å¯ä»¥ä½¿ç”¨åƒä½¿ç”¨æ™®é€šæ–‡ä»¶é‚£æ ·å­æ“ä½œå†…å­˜å¯¹è±¡
è€Œè¿™ä¹Ÿæ­£æ˜¯ VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ virtual file system ï¼ŒåŒ…æ‹¬å†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜ç®¡ç†ç³»ç»Ÿï¼‰çš„è®¾è®¡ç†å¿µä»¥åŠå®ç°æ–¹å‘

VMAï¼ˆvirtual memory areaï¼‰


Linux å†…æ ¸ç”¨vm_area_structç»“æ„ä½“æè¿°æŸä¸€æ®µè¿ç»­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ VMAï¼ˆvirtual memory areaï¼‰ï¼Œæ¯ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸ VMA éƒ½æœ‰è‡ªå·±çš„vm_area_struct ç»“æ„ä½“


å†…å­˜æè¿°ç¬¦ mm_struct æŒ‡å‘è¿›ç¨‹çš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œvm_area_struct åªæ˜¯æŒ‡å‘äº†è™šæ‹Ÿç©ºé—´çš„ä¸€æ®µï¼Œè¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸVMAçš„åœ°å€èŒƒå›´ä¸º [vm_start, vm_end) ï¼Œå·¦å¼€å³é—­



vm_area_struct æ˜¯ç”±åŒå‘é“¾è¡¨é“¾æ¥èµ·æ¥çš„ï¼Œå®ƒä»¬æ˜¯æŒ‰ç…§è™šæ‹Ÿåœ°å€é™åºæ’åºçš„ï¼Œæ¯ä¸ªè¿™æ ·çš„ç»“æ„éƒ½å¯¹åº”æè¿°ä¸€ä¸ªåœ°å€ç©ºé—´èŒƒå›´


ä¸ºäº†å¿«é€Ÿæ ¹æ®åœ°å€æ‰¾åˆ°å¯¹åº”çš„ VMAï¼Œå†…æ ¸å¯¹å…¶å»ºç«‹äº†çº¢é»‘æ ‘ç´¢å¼•ï¼Œçº¢é»‘æ ‘çš„æ¯ä¸ªå¶å­ç»“ç‚¹å°±æ˜¯ä¸€ä¸ªVMAåŒºåŸŸï¼Œå¼•å…¥çº¢é»‘æ ‘çš„å¥½å¤„æ˜¯å¯ä»¥æé«˜æŸ¥æ‰¾VMAçš„æ•ˆç‡ï¼ˆå³ä¾¿VMAçš„æ•°é‡ç¿»å€ï¼ŒVMAçš„æŸ¥æ‰¾æ¬¡æ•°ä¹Ÿåªå¢åŠ ä¸€æ¬¡ï¼‰

    
    
    
        
    




ä¹‹æ‰€ä»¥é€šè¿‡ VMA åˆ†éš”å†…å­˜åŒºåŸŸæ˜¯å› ä¸ºæ¯ä¸ªè™šæ‹ŸåŒºé—´å¯èƒ½æ¥æºä¸åŒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå¯æ‰§è¡Œæ˜ åƒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå…±äº«åº“ï¼Œè€Œæœ‰çš„å¯èƒ½æ˜¯åŠ¨æ€å†…å­˜åˆ†é…çš„å†…å­˜åŒºï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸ªç”± vm_area_struct ç»“æ„æ‰€æè¿°çš„åŒºé—´çš„å¤„ç†æ“ä½œå’Œå®ƒå‰åèŒƒå›´çš„å¤„ç†æ“ä½œä¸åŒï¼Œå› æ­¤ linux æŠŠè™šæ‹Ÿå†…å­˜åˆ†å‰²ç®¡ç†ï¼Œå¹¶åˆ©ç”¨äº†è™šæ‹Ÿå†…å­˜å¤„ç†ä¾‹ç¨‹ vm_ops æ¥æŠ½è±¡å¯¹ä¸åŒæ¥æºè™šæ‹Ÿå†…å­˜çš„å¤„ç†æ–¹æ³•


ä¸åŒçš„è™šæ‹ŸåŒºé—´å…¶å¤„ç†æ“ä½œå¯èƒ½ä¸åŒï¼Œlinux åœ¨è¿™é‡Œåˆ©ç”¨äº†é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œå³æŠŠä¸€ä¸ªè™šæ‹ŸåŒºé—´çœ‹æˆæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨ vm_area_struct æè¿°è¿™ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå…¶ä¸­çš„ vm_operation ç»“æ„æè¿°äº†åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„æ“ä½œ

    
    
    
        
    




è™šæ‹Ÿå†…å­˜ç©ºé—´ç®¡ç†æ¦‚æ‹¬å›¾

    
    
    
        
    

"><meta property="og:type" content="article"><meta property="og:url" content="https://hcy-asleep.github.io/Linux-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%BB%A5%E5%8F%8A%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/"><meta property="og:image" content="https://hcy-asleep.github.io/"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-11-30T19:35:39+00:00"><meta property="article:modified_time" content="2024-11-30T19:35:39+00:00"><meta property="og:site_name" content="HCY-BLOGS"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hcy-asleep.github.io/"><meta name=twitter:title content="Linux è™šæ‹Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜"><meta name=twitter:description content="æœ€è¿‘çœ‹äº†ã€ŠUnderstanding the LinuxÂ® Virtual Memory Managerã€‹é‡Œé¢çš„ç¬¬åäºŒç«  SHARED MEMORY VIRTUAL FILESYSTEM ï¼Œå¯¹æ–‡ä»¶ç³»ç»Ÿä»¥åŠå†…å­˜æ–‡ä»¶ç®¡ç†æœ‰äº†æ›´åŠ æ·±å…¥çš„äº†è§£ï¼Œä¸‹é¢æ˜¯çœ‹äº†è¿™ä¸€ç« èŠ‚ä¹‹åå¯¹å…¶ä¸­ä¸€äº›æ¦‚å¿µçš„ç†è§£ä»¥åŠæ‹“å±•ï¼Œè¦æ˜¯æƒ³äº†è§£è¿™ä¸€ç« ï¼Œå»ºè®®è¯»åŸæ–‡ï¼Œé…åˆè¿™ç¯‡åšå®¢è¾…åŠ©ç†è§£
Linux å“²å­¦

åœ¨ Linux é‡Œé¢ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½å¯ä»¥çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œå‡¡æ˜¯æ–‡ä»¶ï¼Œéƒ½åº”è¯¥æ”¯æŒæˆ–è€…æ¥è¿‘POSIXæ–‡ä»¶æ“ä½œï¼ˆæ¯”å¦‚ read() ï¼Œwrite() ï¼Œopen()ï¼‰
æ¯ä¸€å—å†…å­˜å¯¹è±¡ï¼Œéƒ½å¯ä»¥è¢«çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€æ—¦èµ‹äºˆè¿™å—å†…å­˜å¯¹è±¡ç›¸å¯¹åº”çš„æ–‡ä»¶æè¿°ï¼Œå°±å¯ä»¥ä½¿ç”¨åƒä½¿ç”¨æ™®é€šæ–‡ä»¶é‚£æ ·å­æ“ä½œå†…å­˜å¯¹è±¡
è€Œè¿™ä¹Ÿæ­£æ˜¯ VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ virtual file system ï¼ŒåŒ…æ‹¬å†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜ç®¡ç†ç³»ç»Ÿï¼‰çš„è®¾è®¡ç†å¿µä»¥åŠå®ç°æ–¹å‘

VMAï¼ˆvirtual memory areaï¼‰


Linux å†…æ ¸ç”¨vm_area_structç»“æ„ä½“æè¿°æŸä¸€æ®µè¿ç»­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ VMAï¼ˆvirtual memory areaï¼‰ï¼Œæ¯ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸ VMA éƒ½æœ‰è‡ªå·±çš„vm_area_struct ç»“æ„ä½“


å†…å­˜æè¿°ç¬¦ mm_struct æŒ‡å‘è¿›ç¨‹çš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œvm_area_struct åªæ˜¯æŒ‡å‘äº†è™šæ‹Ÿç©ºé—´çš„ä¸€æ®µï¼Œè¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸVMAçš„åœ°å€èŒƒå›´ä¸º [vm_start, vm_end) ï¼Œå·¦å¼€å³é—­



vm_area_struct æ˜¯ç”±åŒå‘é“¾è¡¨é“¾æ¥èµ·æ¥çš„ï¼Œå®ƒä»¬æ˜¯æŒ‰ç…§è™šæ‹Ÿåœ°å€é™åºæ’åºçš„ï¼Œæ¯ä¸ªè¿™æ ·çš„ç»“æ„éƒ½å¯¹åº”æè¿°ä¸€ä¸ªåœ°å€ç©ºé—´èŒƒå›´


ä¸ºäº†å¿«é€Ÿæ ¹æ®åœ°å€æ‰¾åˆ°å¯¹åº”çš„ VMAï¼Œå†…æ ¸å¯¹å…¶å»ºç«‹äº†çº¢é»‘æ ‘ç´¢å¼•ï¼Œçº¢é»‘æ ‘çš„æ¯ä¸ªå¶å­ç»“ç‚¹å°±æ˜¯ä¸€ä¸ªVMAåŒºåŸŸï¼Œå¼•å…¥çº¢é»‘æ ‘çš„å¥½å¤„æ˜¯å¯ä»¥æé«˜æŸ¥æ‰¾VMAçš„æ•ˆç‡ï¼ˆå³ä¾¿VMAçš„æ•°é‡ç¿»å€ï¼ŒVMAçš„æŸ¥æ‰¾æ¬¡æ•°ä¹Ÿåªå¢åŠ ä¸€æ¬¡ï¼‰

    
    
    
        
    




ä¹‹æ‰€ä»¥é€šè¿‡ VMA åˆ†éš”å†…å­˜åŒºåŸŸæ˜¯å› ä¸ºæ¯ä¸ªè™šæ‹ŸåŒºé—´å¯èƒ½æ¥æºä¸åŒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå¯æ‰§è¡Œæ˜ åƒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå…±äº«åº“ï¼Œè€Œæœ‰çš„å¯èƒ½æ˜¯åŠ¨æ€å†…å­˜åˆ†é…çš„å†…å­˜åŒºï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸ªç”± vm_area_struct ç»“æ„æ‰€æè¿°çš„åŒºé—´çš„å¤„ç†æ“ä½œå’Œå®ƒå‰åèŒƒå›´çš„å¤„ç†æ“ä½œä¸åŒï¼Œå› æ­¤ linux æŠŠè™šæ‹Ÿå†…å­˜åˆ†å‰²ç®¡ç†ï¼Œå¹¶åˆ©ç”¨äº†è™šæ‹Ÿå†…å­˜å¤„ç†ä¾‹ç¨‹ vm_ops æ¥æŠ½è±¡å¯¹ä¸åŒæ¥æºè™šæ‹Ÿå†…å­˜çš„å¤„ç†æ–¹æ³•


ä¸åŒçš„è™šæ‹ŸåŒºé—´å…¶å¤„ç†æ“ä½œå¯èƒ½ä¸åŒï¼Œlinux åœ¨è¿™é‡Œåˆ©ç”¨äº†é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œå³æŠŠä¸€ä¸ªè™šæ‹ŸåŒºé—´çœ‹æˆæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨ vm_area_struct æè¿°è¿™ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå…¶ä¸­çš„ vm_operation ç»“æ„æè¿°äº†åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„æ“ä½œ

    
    
    
        
    




è™šæ‹Ÿå†…å­˜ç©ºé—´ç®¡ç†æ¦‚æ‹¬å›¾

    
    
    
        
    

"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hcy-asleep.github.io/post/"},{"@type":"ListItem","position":2,"name":"Linux è™šæ‹Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜","item":"https://hcy-asleep.github.io/Linux-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%BB%A5%E5%8F%8A%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux è™šæ‹Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜","name":"Linux è™šæ‹Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜","description":"æœ€è¿‘çœ‹äº†ã€ŠUnderstanding the LinuxÂ® Virtual Memory Managerã€‹é‡Œé¢çš„ç¬¬åäºŒç«  SHARED MEMORY VIRTUAL FILESYSTEM ï¼Œå¯¹æ–‡ä»¶ç³»ç»Ÿä»¥åŠå†…å­˜æ–‡ä»¶ç®¡ç†æœ‰äº†æ›´åŠ æ·±å…¥çš„äº†è§£ï¼Œä¸‹é¢æ˜¯çœ‹äº†è¿™ä¸€ç« èŠ‚ä¹‹åå¯¹å…¶ä¸­ä¸€äº›æ¦‚å¿µçš„ç†è§£ä»¥åŠæ‹“å±•ï¼Œè¦æ˜¯æƒ³äº†è§£è¿™ä¸€ç« ï¼Œå»ºè®®è¯»åŸæ–‡ï¼Œé…åˆè¿™ç¯‡åšå®¢è¾…åŠ©ç†è§£\nLinux å“²å­¦ åœ¨ Linux é‡Œé¢ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½å¯ä»¥çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œå‡¡æ˜¯æ–‡ä»¶ï¼Œéƒ½åº”è¯¥æ”¯æŒæˆ–è€…æ¥è¿‘POSIXæ–‡ä»¶æ“ä½œï¼ˆæ¯”å¦‚ read() ï¼Œwrite() ï¼Œopen()ï¼‰ æ¯ä¸€å—å†…å­˜å¯¹è±¡ï¼Œéƒ½å¯ä»¥è¢«çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€æ—¦èµ‹äºˆè¿™å—å†…å­˜å¯¹è±¡ç›¸å¯¹åº”çš„æ–‡ä»¶æè¿°ï¼Œå°±å¯ä»¥ä½¿ç”¨åƒä½¿ç”¨æ™®é€šæ–‡ä»¶é‚£æ ·å­æ“ä½œå†…å­˜å¯¹è±¡ è€Œè¿™ä¹Ÿæ­£æ˜¯ VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ virtual file system ï¼ŒåŒ…æ‹¬å†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜ç®¡ç†ç³»ç»Ÿï¼‰çš„è®¾è®¡ç†å¿µä»¥åŠå®ç°æ–¹å‘ VMAï¼ˆvirtual memory areaï¼‰ Linux å†…æ ¸ç”¨vm_area_structç»“æ„ä½“æè¿°æŸä¸€æ®µè¿ç»­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ VMAï¼ˆvirtual memory areaï¼‰ï¼Œæ¯ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸ VMA éƒ½æœ‰è‡ªå·±çš„vm_area_struct ç»“æ„ä½“\nå†…å­˜æè¿°ç¬¦ mm_struct æŒ‡å‘è¿›ç¨‹çš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œvm_area_struct åªæ˜¯æŒ‡å‘äº†è™šæ‹Ÿç©ºé—´çš„ä¸€æ®µï¼Œè¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸVMAçš„åœ°å€èŒƒå›´ä¸º [vm_start, vm_end) ï¼Œå·¦å¼€å³é—­ vm_area_struct æ˜¯ç”±åŒå‘é“¾è¡¨é“¾æ¥èµ·æ¥çš„ï¼Œå®ƒä»¬æ˜¯æŒ‰ç…§è™šæ‹Ÿåœ°å€é™åºæ’åºçš„ï¼Œæ¯ä¸ªè¿™æ ·çš„ç»“æ„éƒ½å¯¹åº”æè¿°ä¸€ä¸ªåœ°å€ç©ºé—´èŒƒå›´\nä¸ºäº†å¿«é€Ÿæ ¹æ®åœ°å€æ‰¾åˆ°å¯¹åº”çš„ VMAï¼Œå†…æ ¸å¯¹å…¶å»ºç«‹äº†çº¢é»‘æ ‘ç´¢å¼•ï¼Œçº¢é»‘æ ‘çš„æ¯ä¸ªå¶å­ç»“ç‚¹å°±æ˜¯ä¸€ä¸ªVMAåŒºåŸŸï¼Œå¼•å…¥çº¢é»‘æ ‘çš„å¥½å¤„æ˜¯å¯ä»¥æé«˜æŸ¥æ‰¾VMAçš„æ•ˆç‡ï¼ˆå³ä¾¿VMAçš„æ•°é‡ç¿»å€ï¼ŒVMAçš„æŸ¥æ‰¾æ¬¡æ•°ä¹Ÿåªå¢åŠ ä¸€æ¬¡ï¼‰ ä¹‹æ‰€ä»¥é€šè¿‡ VMA åˆ†éš”å†…å­˜åŒºåŸŸæ˜¯å› ä¸ºæ¯ä¸ªè™šæ‹ŸåŒºé—´å¯èƒ½æ¥æºä¸åŒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå¯æ‰§è¡Œæ˜ åƒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå…±äº«åº“ï¼Œè€Œæœ‰çš„å¯èƒ½æ˜¯åŠ¨æ€å†…å­˜åˆ†é…çš„å†…å­˜åŒºï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸ªç”± vm_area_struct ç»“æ„æ‰€æè¿°çš„åŒºé—´çš„å¤„ç†æ“ä½œå’Œå®ƒå‰åèŒƒå›´çš„å¤„ç†æ“ä½œä¸åŒï¼Œå› æ­¤ linux æŠŠè™šæ‹Ÿå†…å­˜åˆ†å‰²ç®¡ç†ï¼Œå¹¶åˆ©ç”¨äº†è™šæ‹Ÿå†…å­˜å¤„ç†ä¾‹ç¨‹ vm_ops æ¥æŠ½è±¡å¯¹ä¸åŒæ¥æºè™šæ‹Ÿå†…å­˜çš„å¤„ç†æ–¹æ³•\nä¸åŒçš„è™šæ‹ŸåŒºé—´å…¶å¤„ç†æ“ä½œå¯èƒ½ä¸åŒï¼Œlinux åœ¨è¿™é‡Œåˆ©ç”¨äº†é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œå³æŠŠä¸€ä¸ªè™šæ‹ŸåŒºé—´çœ‹æˆæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨ vm_area_struct æè¿°è¿™ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå…¶ä¸­çš„ vm_operation ç»“æ„æè¿°äº†åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„æ“ä½œ è™šæ‹Ÿå†…å­˜ç©ºé—´ç®¡ç†æ¦‚æ‹¬å›¾ ","keywords":[],"articleBody":"æœ€è¿‘çœ‹äº†ã€ŠUnderstanding the LinuxÂ® Virtual Memory Managerã€‹é‡Œé¢çš„ç¬¬åäºŒç«  SHARED MEMORY VIRTUAL FILESYSTEM ï¼Œå¯¹æ–‡ä»¶ç³»ç»Ÿä»¥åŠå†…å­˜æ–‡ä»¶ç®¡ç†æœ‰äº†æ›´åŠ æ·±å…¥çš„äº†è§£ï¼Œä¸‹é¢æ˜¯çœ‹äº†è¿™ä¸€ç« èŠ‚ä¹‹åå¯¹å…¶ä¸­ä¸€äº›æ¦‚å¿µçš„ç†è§£ä»¥åŠæ‹“å±•ï¼Œè¦æ˜¯æƒ³äº†è§£è¿™ä¸€ç« ï¼Œå»ºè®®è¯»åŸæ–‡ï¼Œé…åˆè¿™ç¯‡åšå®¢è¾…åŠ©ç†è§£\nLinux å“²å­¦ åœ¨ Linux é‡Œé¢ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½å¯ä»¥çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œå‡¡æ˜¯æ–‡ä»¶ï¼Œéƒ½åº”è¯¥æ”¯æŒæˆ–è€…æ¥è¿‘POSIXæ–‡ä»¶æ“ä½œï¼ˆæ¯”å¦‚ read() ï¼Œwrite() ï¼Œopen()ï¼‰ æ¯ä¸€å—å†…å­˜å¯¹è±¡ï¼Œéƒ½å¯ä»¥è¢«çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€æ—¦èµ‹äºˆè¿™å—å†…å­˜å¯¹è±¡ç›¸å¯¹åº”çš„æ–‡ä»¶æè¿°ï¼Œå°±å¯ä»¥ä½¿ç”¨åƒä½¿ç”¨æ™®é€šæ–‡ä»¶é‚£æ ·å­æ“ä½œå†…å­˜å¯¹è±¡ è€Œè¿™ä¹Ÿæ­£æ˜¯ VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ virtual file system ï¼ŒåŒ…æ‹¬å†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜ç®¡ç†ç³»ç»Ÿï¼‰çš„è®¾è®¡ç†å¿µä»¥åŠå®ç°æ–¹å‘ VMAï¼ˆvirtual memory areaï¼‰ Linux å†…æ ¸ç”¨vm_area_structç»“æ„ä½“æè¿°æŸä¸€æ®µè¿ç»­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ VMAï¼ˆvirtual memory areaï¼‰ï¼Œæ¯ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸ VMA éƒ½æœ‰è‡ªå·±çš„vm_area_struct ç»“æ„ä½“\nå†…å­˜æè¿°ç¬¦ mm_struct æŒ‡å‘è¿›ç¨‹çš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œvm_area_struct åªæ˜¯æŒ‡å‘äº†è™šæ‹Ÿç©ºé—´çš„ä¸€æ®µï¼Œè¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸVMAçš„åœ°å€èŒƒå›´ä¸º [vm_start, vm_end) ï¼Œå·¦å¼€å³é—­ vm_area_struct æ˜¯ç”±åŒå‘é“¾è¡¨é“¾æ¥èµ·æ¥çš„ï¼Œå®ƒä»¬æ˜¯æŒ‰ç…§è™šæ‹Ÿåœ°å€é™åºæ’åºçš„ï¼Œæ¯ä¸ªè¿™æ ·çš„ç»“æ„éƒ½å¯¹åº”æè¿°ä¸€ä¸ªåœ°å€ç©ºé—´èŒƒå›´\nä¸ºäº†å¿«é€Ÿæ ¹æ®åœ°å€æ‰¾åˆ°å¯¹åº”çš„ VMAï¼Œå†…æ ¸å¯¹å…¶å»ºç«‹äº†çº¢é»‘æ ‘ç´¢å¼•ï¼Œçº¢é»‘æ ‘çš„æ¯ä¸ªå¶å­ç»“ç‚¹å°±æ˜¯ä¸€ä¸ªVMAåŒºåŸŸï¼Œå¼•å…¥çº¢é»‘æ ‘çš„å¥½å¤„æ˜¯å¯ä»¥æé«˜æŸ¥æ‰¾VMAçš„æ•ˆç‡ï¼ˆå³ä¾¿VMAçš„æ•°é‡ç¿»å€ï¼ŒVMAçš„æŸ¥æ‰¾æ¬¡æ•°ä¹Ÿåªå¢åŠ ä¸€æ¬¡ï¼‰ ä¹‹æ‰€ä»¥é€šè¿‡ VMA åˆ†éš”å†…å­˜åŒºåŸŸæ˜¯å› ä¸ºæ¯ä¸ªè™šæ‹ŸåŒºé—´å¯èƒ½æ¥æºä¸åŒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå¯æ‰§è¡Œæ˜ åƒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå…±äº«åº“ï¼Œè€Œæœ‰çš„å¯èƒ½æ˜¯åŠ¨æ€å†…å­˜åˆ†é…çš„å†…å­˜åŒºï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸ªç”± vm_area_struct ç»“æ„æ‰€æè¿°çš„åŒºé—´çš„å¤„ç†æ“ä½œå’Œå®ƒå‰åèŒƒå›´çš„å¤„ç†æ“ä½œä¸åŒï¼Œå› æ­¤ linux æŠŠè™šæ‹Ÿå†…å­˜åˆ†å‰²ç®¡ç†ï¼Œå¹¶åˆ©ç”¨äº†è™šæ‹Ÿå†…å­˜å¤„ç†ä¾‹ç¨‹ vm_ops æ¥æŠ½è±¡å¯¹ä¸åŒæ¥æºè™šæ‹Ÿå†…å­˜çš„å¤„ç†æ–¹æ³•\nä¸åŒçš„è™šæ‹ŸåŒºé—´å…¶å¤„ç†æ“ä½œå¯èƒ½ä¸åŒï¼Œlinux åœ¨è¿™é‡Œåˆ©ç”¨äº†é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œå³æŠŠä¸€ä¸ªè™šæ‹ŸåŒºé—´çœ‹æˆæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨ vm_area_struct æè¿°è¿™ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå…¶ä¸­çš„ vm_operation ç»“æ„æè¿°äº†åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„æ“ä½œ è™šæ‹Ÿå†…å­˜ç©ºé—´ç®¡ç†æ¦‚æ‹¬å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # https://elixir.bootlin.com/linux/v2.6.0/source/include/linux/mm.h#L51 struct vm_area_struct { struct mm_struct * vm_mm;\t/* The address space we belong to. */ unsigned long vm_start;\t/* Our start address within vm_mm. */ unsigned long vm_end;\t/* The first byte after our end address within vm_mm. */ /* linked list of VM areas per task, sorted by address */ struct vm_area_struct *vm_next; pgprot_t vm_page_prot;\t/* Access permissions of this VMA. */ unsigned long vm_flags;\t/* Flags, listed below. */ struct rb_node vm_rb; /* * For areas with an address space and backing store, * one of the address_space-\u003ei_mmap{,shared} lists, * for shm areas, the list of attaches, otherwise unused. */ struct list_head shared; /* Function pointers to deal with this struct. */ struct vm_operations_struct * vm_ops; /* Information about our backing store: */ unsigned long vm_pgoff;\t/* Offset (within vm_file) in PAGE_SIZE units, *not* PAGE_CACHE_SIZE */ struct file * vm_file;\t/* File we map to (can be NULL). */ void * vm_private_data;\t/* was vm_pte (shared mem) */ }; struct address_space çœ‹ linux å†…æ ¸å¾ˆå®¹æ˜“è¢« struct address_space è¿™ä¸ªç»“æ„è¿·æƒ‘ï¼Œå®ƒæ˜¯ä»£è¡¨æŸä¸ªåœ°å€ç©ºé—´å—ï¼Ÿå®é™…ä¸Šä¸æ˜¯çš„ï¼Œå®ƒæ˜¯ç”¨äºç®¡ç†æ–‡ä»¶ struct inode æ˜ å°„åˆ°å†…å­˜çš„é¡µé¢ struct page çš„ï¼Œå…¶å®å°±æ˜¯æ¯ä¸ªè¯»å…¥å†…å­˜çš„ file éƒ½æœ‰è¿™ä¹ˆä¸€ä¸ªç»“æ„ï¼Œå°†æ–‡ä»¶ç³»ç»Ÿä¸­è¿™ä¸ª file å¯¹åº”çš„æ•°æ®ä¸è¿™ä¸ª file çš„ç£ç›˜æ•°æ®ä¸å†…å­˜é¡µå¯¹åº”èµ·æ¥ ä¸ä¹‹å¯¹åº”ï¼Œaddress_space_operations å°±æ˜¯ç”¨æ¥æ“ä½œè¯¥æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜çš„é¡µé¢ï¼Œæ¯”å¦‚æŠŠå†…å­˜ä¸­çš„ä¿®æ”¹å†™å›æ–‡ä»¶ã€ä»æ–‡ä»¶ä¸­è¯»å…¥æ•°æ®åˆ°é¡µé¢ç¼“å†²ç­‰ ä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶åœ¨æ‰“å¼€åï¼Œå†…æ ¸ä¼šåœ¨å†…å­˜ä¸­ä¸ºä¹‹å»ºç«‹ä¸€ä¸ª struct inode ç»“æ„ï¼ˆè¯¥ inode ç»“æ„ä¹Ÿä¼šåœ¨å¯¹åº”çš„ file ç»“æ„ä½“ä¸­å¼•ç”¨ï¼‰ï¼Œå…¶ä¸­çš„ i_mapping åŸŸæŒ‡å‘ä¸€ä¸ª address_space ç»“æ„ ä¸€ä¸ªæ–‡ä»¶å°±å¯¹åº”ä¸€ä¸ª address_space ç»“æ„ï¼Œä¸€ä¸ª address_space ä¸ä¸€ä¸ªåç§»é‡èƒ½å¤Ÿç¡®å®šä¸€ä¸ª page cache æˆ– swap cache ä¸­çš„ä¸€ä¸ªé¡µé¢ï¼Œå½“è¦å¯»å€æŸä¸ªæ•°æ®æ—¶ï¼Œå¾ˆå®¹æ˜“æ ¹æ®ç»™å®šçš„æ–‡ä»¶åŠæ•°æ®åœ¨æ–‡ä»¶å†…çš„åç§»é‡è€Œæ‰¾åˆ°ç›¸åº”çš„é¡µé¢ struct file å’Œ struct inode ç»“æ„ä½“ä¸­éƒ½æœ‰ä¸€ä¸ª struct address_space æŒ‡é’ˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # https://elixir.bootlin.com/linux/v2.6.0/source/include/linux/fs.h#L319 struct address_space { struct inode\t*host;\t/* owner: inode, block_device */ struct radix_tree_root\tpage_tree;\t/* radix tree of all pages */ spinlock_t\tpage_lock;\t/* and spinlock protecting it */ struct list_head\tclean_pages;\t/* list of clean pages */ struct list_head\tdirty_pages;\t/* list of dirty pages */ struct list_head\tlocked_pages;\t/* list of locked pages */ struct list_head\tio_pages;\t/* being prepared for I/O */ unsigned long\tnrpages;\t/* number of total pages */ struct address_space_operations *a_ops;\t/* methods */ struct list_head\ti_mmap;\t/* list of private mappings */ struct list_head\ti_mmap_shared;\t/* list of shared mappings */ struct semaphore\ti_shared_sem;\t/* protect both above lists */ atomic_t\ttruncate_count;\t/* Cover race condition with truncate */ unsigned long\tdirtied_when;\t/* jiffies of first page dirtying */ unsigned long\tflags;\t/* error bits/gfp mask */ struct backing_dev_info *backing_dev_info; /* device readahead, etc */ spinlock_t\tprivate_lock;\t/* for use by the address_space */ struct list_head\tprivate_list;\t/* ditto */ struct address_space\t*assoc_mapping;\t/* ditto */ }; æ–‡ä»¶ç³»ç»Ÿã€æ–‡ä»¶ç±»å‹ã€page çš„åˆ’åˆ† ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œåœ¨æ­¤å°†æ–‡ä»¶ç³»ç»Ÿåˆ’åˆ†ä¸ºå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ä¸ç¡¬ç›˜æ–‡ä»¶ç³»ç»Ÿï¼ˆç‰©ç†æ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œåœ¨ä¹¦çš„è¿™ä¸€ç« èŠ‚é‡Œé¢ï¼Œä¹Ÿå°†å¹¿ä¹‰ä¸Šçš„æ–‡ä»¶åˆ†ä¸º virtual file å’Œ physical file åœ¨ä¹¦çš„è¿™ä¸€ç« èŠ‚é‡Œé¢ï¼Œå°†å†…å­˜é¡µé¢ page åˆ’åˆ†ä¸º anonymous pages ï¼ˆæ²¡æœ‰ç‰©ç†æ–‡ä»¶æ”¯æŒçš„å†…å­˜é¡µé¢ï¼‰ä¸ pages backed by a fileï¼ˆç”±ç‰©ç†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜çš„æŸäº› pagesï¼‰ page cache ä¸ swap cache page cache æ˜¯ä¸æ–‡ä»¶æ˜ å°„å¯¹åº”çš„ï¼Œè€Œ swap cache æ˜¯ä¸åŒ¿åé¡µå¯¹åº”çš„ å¦‚æœä¸€ä¸ªå†…å­˜é¡µé¢ä¸æ˜¯æ–‡ä»¶æ˜ å°„ï¼Œåˆ™åœ¨æ¢å…¥æ¢å‡ºçš„æ—¶å€™åŠ å…¥åˆ° swap cache ï¼Œå¦‚æœæ˜¯æ–‡ä»¶æ˜ å°„ï¼Œåˆ™ä¸éœ€è¦äº¤æ¢ç¼“å†² è¿™ä¸¤ä¸ªçš„ç›¸åŒç‚¹å°±æ˜¯å®ƒä»¬éƒ½æ˜¯ address_space ï¼Œéƒ½æœ‰ç›¸å¯¹åº”çš„æ–‡ä»¶æ“ä½œï¼šä¸€ä¸ªè¢«è®¿é—®çš„æ–‡ä»¶çš„ç‰©ç†é¡µé¢éƒ½é©»ç•™åœ¨ page cache æˆ– swap cache ä¸­ï¼Œä¸€ä¸ªé¡µé¢çš„æ‰€æœ‰ä¿¡æ¯ç”± struct page æ¥æè¿° page cache ä½œç”¨ å½“æ–‡ä»¶è¢«è¯»å–æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠæ–‡ä»¶å†…å®¹åŠ è½½åˆ°å†…å­˜çš„ page cache ä¸­ å¦‚æœåŒä¸€ä¸ªæ–‡ä»¶è¢«å†æ¬¡è®¿é—®ï¼Œæ“ä½œç³»ç»Ÿä¼šç›´æ¥ä» page cache ä¸­è¯»å–ï¼Œè€Œä¸æ˜¯å†æ¬¡ä»ç£ç›˜è¯»å–ï¼Œä»è€Œå‡å°‘ç£ç›˜è®¿é—®æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½ swap cache ä½œç”¨ swap cache ç¼“å­˜çš„æ˜¯å·²ç»äº¤æ¢åˆ°ç£ç›˜çš„æ•°æ®ï¼Œå®ƒæ˜¯ä¸ºäº†æé«˜äº¤æ¢æ“ä½œçš„æ•ˆç‡ï¼Œä¼˜åŒ–è™šæ‹Ÿå†…å­˜çš„äº¤æ¢æ“ä½œ å¦‚æœå†…å­˜ä¸­å†æ¬¡éœ€è¦ä½¿ç”¨è¿™äº›é¡µé¢ï¼Œæ“ä½œç³»ç»Ÿä¼šä» swap cache é‡Œé¢å¯»æ‰¾ï¼Œç„¶åå†ä» swap é‡Œé¢æŸ¥æ‰¾ åŒæ—¶å¯¹äºé‚£äº›åˆšåˆšä»ç‰©ç†å†…å­˜é‡Œé¢æ¢å‡ºæ¥çš„ page ä»¥åŠä» swap ç©ºé—´è¯»å–çš„ page ä¹Ÿä¼šæ”¾åœ¨ swap cache é‡Œé¢ ä¸€èˆ¬æƒ…å†µä¸‹ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ mmap() æ—¶ï¼Œåªæ˜¯åœ¨è¿›ç¨‹ç©ºé—´å†…æ–°å¢äº†ä¸€å—ç›¸åº”å¤§å°çš„ç¼“å†²åŒºï¼Œå¹¶è®¾ç½®äº†ç›¸åº”çš„è®¿é—®æ ‡è¯†ï¼Œä½†å¹¶æ²¡æœ‰å»ºç«‹è¿›ç¨‹ç©ºé—´åˆ°ç‰©ç†é¡µé¢çš„æ˜ å°„ å› æ­¤ï¼Œç¬¬ä¸€æ¬¡è®¿é—®è¯¥ç©ºé—´æ—¶ï¼Œä¼šå¼•å‘ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸ å¯¹äºå…±äº«å†…å­˜æ˜ å°„æƒ…å†µ ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºé¦–å…ˆåœ¨ swap cache ä¸­å¯»æ‰¾ç›®æ ‡é¡µï¼ˆç¬¦åˆ address_space ä»¥åŠåç§»é‡çš„ç‰©ç†é¡µï¼‰ å¦‚æœæ‰¾åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›åœ°å€ å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™åˆ¤æ–­è¯¥é¡µæ˜¯å¦åœ¨äº¤æ¢åŒº (swap area)ï¼Œå¦‚æœåœ¨ï¼Œåˆ™æ‰§è¡Œä¸€ä¸ªæ¢å…¥æ“ä½œ å¦‚æœä¸Šè¿°ä¸¤ç§æƒ…å†µéƒ½ä¸æ»¡è¶³ï¼Œå¤„ç†ç¨‹åºå°†åˆ†é…æ–°çš„ç‰©ç†é¡µé¢ï¼Œå¹¶æŠŠå®ƒæ’å…¥åˆ° page cache ä¸­ï¼Œæœ€ç»ˆå°†æ›´æ–°è¿›ç¨‹é¡µè¡¨ å¯¹äºæ˜ å°„æ™®é€šæ–‡ä»¶æƒ…å†µï¼ˆéå…±äº«æ˜ å°„ï¼‰ ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºé¦–å…ˆä¼šåœ¨ page cache ä¸­æ ¹æ® address_space ä»¥åŠæ•°æ®åç§»é‡å¯»æ‰¾ç›¸åº”çš„é¡µé¢ å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¯´æ˜æ–‡ä»¶æ•°æ®è¿˜æ²¡æœ‰è¯»å…¥å†…å­˜ï¼Œå¤„ç†ç¨‹åºä¼šä»ç£ç›˜è¯»å…¥ç›¸åº”çš„é¡µé¢ï¼Œå¹¶è¿”å›ç›¸åº”åœ°å€ï¼ŒåŒæ—¶è¿›ç¨‹é¡µè¡¨ä¹Ÿä¼šæ›´æ–° ç¡¬ç›˜ï¼ˆç‰©ç†ï¼‰æ–‡ä»¶ç³»ç»Ÿ åœ¨ Linux æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œdentryï¼ˆç›®å½•é¡¹ï¼‰å’Œ inodeï¼ˆç´¢å¼•èŠ‚ç‚¹ï¼‰æ˜¯ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒä»¬æ˜¯æ–‡ä»¶ç³»ç»Ÿå†…éƒ¨ç”¨äºè¡¨ç¤ºå’Œç®¡ç†æ–‡ä»¶ã€ç›®å½•åŠå…¶å±æ€§çš„æ•°æ®ç»“æ„\ndentryï¼ˆç›®å½•é¡¹ï¼‰ dentry æ˜¯ä¸€ä¸ª ç›®å½•é¡¹ çš„æ•°æ®ç»“æ„ï¼Œå®ƒè¡¨ç¤ºæ–‡ä»¶è·¯å¾„åä¸æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½ç½®ä¹‹é—´çš„æ˜ å°„å…³ç³» æ¯ä¸ª dentry å…³è”äº†ä¸€ä¸ªè·¯å¾„ç»„ä»¶ï¼ˆå¦‚æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶åï¼‰ï¼Œå¹¶æŒ‡å‘æ–‡ä»¶ç³»ç»Ÿä¸­çš„ inodeï¼Œå†…æ ¸é€šè¿‡é€çº§è§£æè·¯å¾„æ¥æŸ¥æ‰¾æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 struct dentry { ...... struct inode * d_inode;\t/* Where the name belongs to - NULL is negative */ ...... struct list_head d_child;\t/* child of parent list */ struct list_head d_subdirs;\t/* our children */ ...... struct qstr d_name; /* file name */ ...... }; struct qstr { const unsigned char * name; unsigned int len; unsigned int hash; char name_str[0]; }; inodeï¼ˆç´¢å¼•èŠ‚ç‚¹ï¼‰ inode æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­ç”¨äºæè¿°æ–‡ä»¶æˆ–ç›®å½•çš„å…ƒæ•°æ®çš„æ•°æ®ç»“æ„ï¼Œæ˜¯æ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œé™¤äº†æ–‡ä»¶åä¹‹å¤–ï¼Œå®ƒåŒ…å«äº†æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š æ–‡ä»¶ç±»å‹ï¼ˆæ™®é€šæ–‡ä»¶ã€ç›®å½•ã€ç¬¦å·é“¾æ¥ç­‰ï¼‰ æ–‡ä»¶æƒé™ï¼ˆè¯»ã€å†™ã€æ‰§è¡Œæƒé™ï¼‰ æ–‡ä»¶æ‰€æœ‰è€…å’Œç”¨æˆ·ç»„ æ–‡ä»¶å¤§å° æ–‡ä»¶çš„æ—¶é—´æˆ³ï¼ˆåˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´ã€è®¿é—®æ—¶é—´ï¼‰ æ–‡ä»¶æ•°æ®å—çš„ä½ç½®ï¼ˆæŒ‡å‘æ•°æ®å—çš„æŒ‡é’ˆï¼‰ï¼ŒåŒ…æ‹¬ç›´æ¥å—æŒ‡é’ˆ i_direct ä¸é—´æ¥å—æŒ‡é’ˆ i_indirect inode æŒ‡å‘æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†ä½ç½®ï¼Œå¸®åŠ©æ“ä½œç³»ç»Ÿå®šä½æ–‡ä»¶æ•°æ®å—ï¼Œä»è€Œå®ç°æ–‡ä»¶çš„è¯»å–å’Œå†™å…¥ i_nlink i_nlink æ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨ inode ç»“æ„ä¸­çš„å­—æ®µï¼Œè¡¨ç¤ºæŒ‡å‘è¯¥ inode çš„ç¡¬é“¾æ¥æ•°é‡ å¯¹äºæ™®é€šæ–‡ä»¶ i_nlink è®°å½•çš„æ˜¯æŒ‡å‘è¯¥æ–‡ä»¶çš„ç¡¬é“¾æ¥æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ–‡ä»¶çš„ i_nlink æ˜¯è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªç›®å½•é¡¹æŒ‡å‘è¯¥æ–‡ä»¶çš„ inode æ¯å½“åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šä¸ºè¯¥æ–‡ä»¶åˆ†é…ä¸€ä¸ª inode,è€Œæ–‡ä»¶çš„ i_nlink åˆå§‹å€¼ä¸º 1ï¼Œè¿™ä¸ª 1 ä»£è¡¨ç€è‡ªå·± å¯¹äºç›®å½• i_nlink è®°å½•çš„æ˜¯æŒ‡å‘è¯¥ç›®å½•çš„ç¡¬é“¾æ¥æ•°ï¼Œå®ƒçš„å€¼è¿˜ä¸å­ç›®å½•çš„å­˜åœ¨æœ‰å…³ æ¯åˆ›å»ºä¸€ä¸ªå­ç›®å½•ï¼Œçˆ¶ç›®å½•çš„ i_nlink ä¼šå¢åŠ  æ¯ä¸ªå­ç›®å½•çš„ inode è¢«åˆ›å»ºæ—¶ï¼Œçˆ¶ç›®å½•çš„ nlink ä¼šå¢åŠ  1ï¼Œå› ä¸ºå­ç›®å½•ä¼šæœ‰ä¸€ä¸ªæŒ‡å‘çˆ¶ç›®å½•çš„ç¡¬é“¾æ¥ï¼ˆå³ .. é“¾æ¥ï¼‰ dentry å’Œ inode çš„å…³ç³» å…³è”æ€§ æ¯ä¸ª dentry å¯¹åº”ä¸€ä¸ªè·¯å¾„ç»„ä»¶ï¼ˆä¾‹å¦‚æŸä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„åç§°ï¼‰ï¼Œå¹¶ä¸”æ¯ä¸ª dentry éƒ½æŒ‡å‘ä¸€ä¸ª inode é€šè¿‡ inodeï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥æ‰¾åˆ°æ–‡ä»¶çš„å®é™…æ•°æ®ï¼Œè€Œ dentry åˆ™æ˜¯é€šè¿‡æ–‡ä»¶åæ¥æŒ‡å‘ inode æ¢å¥è¯è¯´ï¼Œdentry æä¾›äº†æ–‡ä»¶è·¯å¾„åˆ°æ–‡ä»¶æ•°æ®ä½ç½®ï¼ˆå³ inodeï¼‰çš„æ˜ å°„å…³ç³» è·¯å¾„è§£æ å½“ä¸€ä¸ªè·¯å¾„è¢«è®¿é—®æ—¶ï¼Œå†…æ ¸ä¼šé€æ­¥è§£æè·¯å¾„ä¸­çš„æ¯ä¸ªç›®å½•é¡¹ï¼ˆdentryï¼‰ï¼Œé€šè¿‡ç›®å½•é¡¹æ‰¾åˆ°å¯¹åº”çš„ inode æ¯ä¸ªç›®å½•é¡¹ï¼ˆdentryï¼‰éƒ½å­˜å‚¨äº†ä¸€ä¸ªæŒ‡å‘å¯¹åº” inode çš„æŒ‡é’ˆ å½“æœ€ç»ˆè§£æåˆ°æ–‡ä»¶åæ—¶ï¼Œå†…æ ¸é€šè¿‡è¯¥ inode è·å–æ–‡ä»¶çš„å…ƒæ•°æ®å¹¶å®šä½æ–‡ä»¶æ•°æ®å— ç¼“å­˜æœºåˆ¶ ä¸ºäº†æé«˜æ€§èƒ½ï¼Œå†…æ ¸ä¼šç¼“å­˜è·¯å¾„åå’Œ inode ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œè¿™æ ·åœ¨è®¿é—®åŒä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•æ—¶ï¼Œå¯ä»¥é¿å…é‡å¤è§£æè·¯å¾„ ç”¨ dentry æ„å»ºâ€œå¤šå‰æ ‘â€æ–‡ä»¶ç³»ç»Ÿ åœ¨ Linux å†…æ ¸ä¸­åªéœ€è¦ç”¨åˆ° struct list_head d_child å’Œ struct list_head d_subdirs è¿™ä¸¤ä¸ªä¸¤ä¸ªå…³é”®åŒå‘é“¾è¡¨å°±å¯ä»¥å®ç°ç›®å½•æ ‘ç»“æ„\n1 2 3 4 5 6 7 8 9 10 struct dentry { ...... struct list_head d_child;\t/* child of parent list */ struct list_head d_subdirs;\t/* our children */ ...... }; struct list_head { struct list_head *next, *prev; }; d_child\nè¡¨ç¤ºå½“å‰ç›®å½•é¡¹åœ¨çˆ¶ç›®å½•çš„å­é¡¹é“¾è¡¨ä¸­çš„ä½ç½® å®ƒè¿æ¥åˆ°çˆ¶ç›®å½•çš„ d_subdirs é“¾è¡¨ï¼Œç”¨äºå½¢æˆç›®å½•æ ‘ä¸­çš„çˆ¶å­å…³ç³» d_child -\u003e prev ä¸ºçˆ¶ç›®å½•æˆ–è€…å…„å¼Ÿ d_child -\u003e next ä¸ºå…„å¼Ÿæˆ–è€… NULL d_subdirs\nè¡¨ç¤ºå½“å‰ç›®å½•çš„å­ç›®å½•å’Œæ–‡ä»¶åˆ—è¡¨ ç”¨äºéå†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰å­é¡¹ å½“å‰ç›®å½•ä¸‹çš„æ¯ä¸ªå­é¡¹ï¼ˆæ–‡ä»¶æˆ–å­ç›®å½•ï¼‰çš„ d_child éƒ½ä¼šè¢«æŒ‚æ¥åˆ° d_subdirs é“¾è¡¨ä¸­ d_subdirs -\u003e prev ä¸º NULL d_subdirs -\u003e next ä¸ºå½“å‰ç›®å½•ä¸‹ç¬¬ä¸€ä¸ªå­©å­æˆ–è€… NULL åœ¨å½“å‰ç›®å½•æ–°å»ºæ–‡ä»¶æ—¶ï¼Œåˆ›å»ºçš„æ–‡ä»¶ä¼šä»¥å¤´æ’æ³•æ’åˆ° d_subdirs -\u003e next d_subdirs ä¸ d_child é…åˆ\nd_subdirs ç»´æŠ¤å­é¡¹åˆ—è¡¨ï¼Œd_child é“¾æ¥åˆ°çˆ¶ç›®å½•çš„å­é¡¹é“¾è¡¨ï¼Œå½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„çš„ç›®å½•æ ‘ å‡è®¾æ–‡ä»¶ç³»ç»Ÿç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 / â”œâ”€â”€ home/ â”‚ â”œâ”€â”€ user/ â”‚ â”‚ â”œâ”€â”€ file1 â”‚ â”‚ â””â”€â”€ documents/ â””â”€â”€ etc/ é‚£ä¹ˆå®ƒä»¬ä¹‹é—´çš„é“¾è¡¨å…³ç³»å›¾åº”è¯¥æ˜¯è¿™æ ·å­çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 (root /) d_child d_subdirs + | +--\u003e (home) d_child | d_subdirs | + | | | +--\u003e (user) d_child | d_subdirs | + | | | +--\u003e (file1) d_child | | | +--\u003e (documents) d_child | +--\u003e (etc) d_child ç°åœ¨è¿˜å‰©ä¸‹æœ€åä¸€ä¸ªé—®é¢˜ï¼Œd_subdirs æ˜¯ list_head ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå®ƒæœ¬èº«åªåŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼šnext å’Œ prevï¼Œåº”è¯¥å¦‚ä½•é€šè¿‡ list_head æ‰¾åˆ°åŒ…å«å®ƒçš„ struct dentry å‘¢ï¼Ÿ\nåœ¨å†…æ ¸é‡Œé¢ï¼Œå®ç°è¿™ä¸ªç›®æ ‡éœ€è¦ä¾èµ–åµŒå¥—ç»“æ„å’Œåç§»é‡è®¡ç®—\nè€Œè¿™ä¸€æ­¥çš„å…³é”®å‡½æ•°æ˜¯ contianer_of\n1 2 #define container_of(ptr, type, member) \\ ((type *)((char *)(ptr) - offsetof(type, member))) åœ¨ dentry è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œcontainer_of é‡Œé¢çš„å„ä¸ªå‚æ•°å¯ä»¥è¿™æ ·å­ç†è§£\nptr ï¼šlist_head æŒ‡é’ˆï¼Œä¾‹å¦‚ \u0026dir-\u003ed_subdirs typeï¼šåŒ…å« list_head çš„ç»“æ„ä½“ç±»å‹ï¼ˆè¿™é‡Œæ˜¯ struct dentryï¼‰ memberï¼šlist_head å­—æ®µåœ¨ç»“æ„ä½“ä¸­çš„åå­—ï¼ˆè¿™é‡Œæ˜¯ d_subdirsï¼‰ offsetof(type, member)ï¼šè·å– member åœ¨ type ä¸­çš„åç§»é‡ï¼Œé€šè¿‡ ptr å‡å» member çš„åç§»é‡ï¼Œè®¡ç®—å‡ºç»“æ„ä½“çš„èµ·å§‹åœ°å€ åˆ é™¤ç›®å½• åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œåˆ é™¤ä¸€ä¸ªç›®å½•æ—¶ï¼Œå†…æ ¸ä¼šä½¿ç”¨æ·±åº¦ä¼˜å…ˆç®—æ³•é€’å½’åœ°åˆ é™¤è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½• tmpfs ä¸ shm è”ç³» shm introduction shm æ˜¯ Linux å†…æ ¸å†…éƒ¨å®ç°åŒ¿åå†…å­˜å…±äº«çš„æœºåˆ¶ï¼Œä¸»è¦ä¸ºå†…æ ¸æœåŠ¡ï¼Œä¸å¯¹ç”¨æˆ·ç›´æ¥å¯è§ shm æœ€åˆè®¾è®¡æ˜¯ä¸ºæ”¯æŒ POSIX å…±äº«å†…å­˜ï¼ˆå¦‚ shm_openï¼‰å’Œ System V å…±äº«å†…å­˜ï¼ˆå¦‚ shmgetï¼‰ï¼Œå…±äº«å†…å­˜éœ€è¦ä¸€ä¸ªä¸´æ—¶çš„ã€å†…å­˜é©»ç•™çš„æ–‡ä»¶ç³»ç»Ÿæ¥å­˜å‚¨å…±äº«çš„å†…å­˜é¡µ shm ä¸ºåŒ¿åé¡µé¢æä¾›ç»Ÿä¸€çš„æ–‡ä»¶æ”¯æŒæ¥å£ï¼Œä½¿å†…æ ¸å¯ä»¥ç”¨æ–‡ä»¶æ“ä½œå‡½æ•°ï¼ˆå¦‚ readpage æˆ– writepageï¼‰ç®¡ç†è¿™äº›é¡µé¢ï¼Œå®ç°åŒ¿åå…±äº«å†…å­˜ï¼ˆå¦‚é€šè¿‡ mmap åˆ›å»ºçš„ MAP_ANONYMOUS | MAP_SHARED åŒºåŸŸï¼‰å’Œ System V å…±äº«å†…å­˜ï¼ˆshmgetï¼‰ shm å¯¹è™šæ‹Ÿæ–‡ä»¶çš„æè¿°éƒ½æ˜¯ä½¿ç”¨ shmem_inode_info ï¼ˆ shmem_inode_info å¯ä»¥çœ‹ä½œ inode çš„ç»§æ‰¿ï¼Œåœ¨å†…å­˜æ–‡ä»¶ç³»ç»Ÿé‡Œé¢å¦‚æœè¦åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œè¦å…ˆå‘ç³»ç»Ÿç”³è¯·ä¸€ä¸ª inode ï¼Œç„¶åæ‰æ˜¯å°†è¿™ä¸ª inode ä¼ ç»™ shmem_inode_info ï¼Œæœ‰ç‚¹ç±»ä¼¼ C++ é‡Œé¢çš„å½“ä¸€ä¸ªå­ç±»è¦å®ä¾‹åŒ–çš„æ—¶å€™éœ€è¦å…ˆå®ä¾‹åŒ–çˆ¶ç±»ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 // https://elixir.bootlin.com/linux/v2.6.0/source/include/linux/shmem_fs.h#L10 struct shmem_inode_info { spinlock_t\tlock; unsigned long\tnext_index; swp_entry_t\ti_direct[SHMEM_NR_DIRECT]; /* for the first blocks */ struct page\t*i_indirect; /* indirect blocks */ unsigned long\talloced; /* data pages allocated to file */ unsigned long\tswapped; /* subtotal assigned to swap */ unsigned long\tflags; struct list_head\tlist; struct inode\tvfs_inode; }; tmpfs introduction tmpfs æ˜¯é¢å‘ç”¨æˆ·çš„ã€é€šç”¨çš„åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨ RAM ä½œä¸ºå­˜å‚¨åª’ä»‹ï¼Œç”¨äºæä¾›ä¸´æ—¶å­˜å‚¨å’Œå…±äº«å†…å­˜åŠŸèƒ½ï¼Œèƒ½å¤Ÿé€šè¿‡æŒ‚è½½ç‚¹æä¾›æ›´å¤šåŠŸèƒ½ tmpfs çš„æ ¸å¿ƒå®ç°æ–‡ä»¶åœ¨å†…æ ¸çš„ shm.cï¼Œtmpfs çš„è®¸å¤šåŠŸèƒ½ï¼ŒåŒ…æ‹¬å†…å­˜é¡µçš„ç®¡ç†ã€inode çš„åˆ›å»ºå’Œæ“ä½œç­‰ï¼Œéƒ½åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®ç° tmpfs çš„æ ¸å¿ƒå®ç°æºè‡ªäº shm shm åœ¨é€šå¸¸è¯­å¢ƒä¸‹ç¡®å®æ˜¯å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰çš„ç¼©å†™ï¼Œä½†åœ¨ Linux å†…æ ¸ä¸­ï¼Œshmem æŒ‡çš„æ˜¯ä¸€ä¸ªæ›´é€šç”¨çš„æœºåˆ¶ï¼Œæ—¢ç”¨äºå…±äº«å†…å­˜ï¼Œä¹Ÿä¸º tmpfs æä¾›æ”¯æŒï¼Œè¿™æºäº Linux å†…æ ¸è®¾è®¡ä¸­å¯¹å†…å­˜ç®¡ç†çš„ç»Ÿä¸€æŠ½è±¡ shm è¿™ä¸ªåå­—æ›´å¤šåæ˜ äº†å…¶å†å²èƒŒæ™¯ï¼Œç”±æœ€åˆæ”¯æŒå…±äº«å†…å­˜æœºåˆ¶çš„ä¸»è¦ç›®æ ‡ï¼Œåˆ°åæ¥é€æ¸æ‰©å±•åˆ°æ”¯æŒ tmpfs éšç€ tmpfs çš„å¼•å…¥ï¼ŒLinux ç›´æ¥å¤ç”¨äº† shmem çš„åŸºç¡€è®¾æ–½ï¼Œå› ä¸ºå®ƒä»¬çš„æ ¸å¿ƒéœ€æ±‚ä¸€è‡´ï¼šä¸€ç§æ— æŒä¹…å­˜å‚¨åç«¯ã€åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿ å› æ­¤ shm è¿™ç§å‘½åå¹¶ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„â€œå…±äº«å†…å­˜â€é™å®šï¼Œè€Œæ˜¯ä¸€ä¸ªå†å²é—ç•™çš„åå­— å½“ä½¿ç”¨ tmpfs æˆ–å…±äº«å†…å­˜æ—¶ï¼Œå†…æ ¸å®é™…ä¸Šéƒ½åœ¨è°ƒç”¨ shmem ç›¸å…³çš„åŠŸèƒ½ï¼Œæ¢å¥è¯è¯´ï¼Œtmpfs å’Œå…±äº«å†…å­˜æ˜¯åŒä¸€ä¸ªæœºåˆ¶åœ¨ä¸åŒåœºæ™¯ä¸‹çš„ä¸¤ä¸ªåº”ç”¨å®ä¾‹ shmem å’Œ tmpfs æ ¸å¿ƒéœ€æ±‚ä¸€è‡´ï¼š åŠ¨æ€åˆ†é…é¡µï¼ˆåœ¨éœ€è¦æ—¶ä¸ºæ–‡ä»¶æˆ–å…±äº«å†…å­˜æ®µåˆ†é…å†…å­˜é¡µï¼‰ æ”¯æŒæŒ‰éœ€å¢é•¿ï¼ˆtmpfs æ–‡ä»¶æˆ–å…±äº«å†…å­˜æ®µä¼šéšå†…å®¹å¢é•¿ï¼‰ å†…å­˜é¡µé¢å¯ä»¥è¢«å›æ”¶æˆ–å†™å…¥äº¤æ¢åˆ†åŒºï¼ˆswappingï¼‰ shmem æ˜¯åº•å±‚æœºåˆ¶ï¼Œæœ€åˆæœåŠ¡äºå…±äº«å†…å­˜éœ€æ±‚ tmpfs æ˜¯åŸºäº shmem çš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œæ‰©å±•äº†å…¶ä½¿ç”¨åœºæ™¯ï¼Œæ”¯æŒä¸´æ—¶æ–‡ä»¶å­˜å‚¨ tmpfs çš„è¯ç”Ÿå¾—ç›Šäº shmem çš„å­˜åœ¨ï¼Œæ˜¯å…±äº«å†…å­˜æŠ€æœ¯çš„ä¸€æ¬¡æˆåŠŸå¤ç”¨ shm ä½¿ç”¨ System V å…±äº«å†…å­˜\n1 2 3 4 5 // ä½¿ç”¨ `shmget` å’Œ `shmat` åˆ›å»ºçš„å…±äº«å†…å­˜æ®µï¼Œé€šè¿‡ `shm` æä¾›åº•å±‚æ”¯æŒ int shmid = shmget(IPC_PRIVATE, 1024, IPC_CREAT | 0666); char *data = shmat(shmid, NULL, 0); strcpy(data, \"Hello, shm!\"); printf(\"Data in shared memory: %s\\n\", data); åŒ¿åå…±äº«å†…å­˜\n1 2 3 4 5 6 7 8 9 10 // å½“è¿›ç¨‹è°ƒç”¨ `mmap` å¹¶æŒ‡å®š `MAP_ANONYMOUS | MAP_SHARED` æ—¶ï¼Œ`shm` ä¼šä¸ºè¿™äº›åŒ¿åé¡µé¢åˆ›å»ºæ”¯æŒ size_t size = 4096; // åˆ†é…ä¸€ä¸ª4KBçš„å†…å­˜åŒºåŸŸ void *addr = mmap(NULL, size, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0); if (addr == MAP_FAILED) { perror(\"mmap failed\"); return 1; } // é€šè¿‡æŒ‡é’ˆè®¿é—®å¹¶ä¿®æ”¹åŒ¿åå…±äº«å†…å­˜ int *data = (int *)addr; ä½¿ç”¨ POSIX æ–‡ä»¶æ¥å£ä¸ shm ç»“åˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 const char *shm_name = \"/my_shm\"; // å…±äº«å†…å­˜å¯¹è±¡çš„åç§° size_t size = 4096; // å…±äº«å†…å­˜çš„å¤§å° // åˆ›å»ºæˆ–æ‰“å¼€å…±äº«å†…å­˜å¯¹è±¡ // ä½¿ç”¨ shm_open() åˆ›å»ºæˆ–æ‰“å¼€å…±äº«å†…å­˜å¯¹è±¡åï¼Œè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥é€šè¿‡ open() è¿›è¡Œè®¿é—® int shm_fd = shm_open(shm_name, O_CREAT | O_RDWR, S_IRUSR | S_IWUSR); if (shm_fd == -1) { perror(\"shm_open\"); return 1; } // è®¾ç½®å…±äº«å†…å­˜çš„å¤§å° if (ftruncate(shm_fd, size) == -1) { perror(\"ftruncate\"); return 1; } // å°†å…±äº«å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ void *shm_ptr = mmap(NULL, size, PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, 0); if (shm_ptr == MAP_FAILED) { perror(\"mmap\"); return 1; } // ä½¿ç”¨å…±äº«å†…å­˜ // å†™å…¥æ•°æ®åˆ°å…±äº«å†…å­˜ snprintf((char *)shm_ptr, size, \"Hello from shared memory!\"); // è§£é™¤æ˜ å°„ if (munmap(shm_ptr, size) == -1) { perror(\"munmap\"); return 1; } // å…³é—­å…±äº«å†…å­˜å¯¹è±¡ close(shm_fd); tmpfs ä½¿ç”¨ tmpfs é»˜è®¤æŒ‚è½½åˆ° /tmpï¼Œä¸ºç”¨æˆ·æä¾›å¿«é€Ÿçš„ã€åŸºäº RAM çš„ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ç©ºé—´ï¼Œè¯»å†™é€Ÿåº¦å¿«ï¼Œå®ƒä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‚è½½åˆ°å…¶ä»–åœ°æ–¹ 1 2 3 4 5 6 7 8 9 # åœ¨ /mnt/tmpfs æŒ‚è½½ä¸€ä¸ª tmpfs æ–‡ä»¶ç³»ç»Ÿ sudo mount -t tmpfs -o size=128M tmpfs /mnt/tmpfs # åœ¨ tmpfs ä¸Šåˆ›å»ºæ–‡ä»¶ echo \"Hello, tmpfs!\" \u003e /mnt/tmpfs/testfile cat /mnt/tmpfs/testfile # å¸è½½ tmpfs sudo umount /mnt/tmpfs tmpfs ä¹Ÿå¯ä»¥ä½¿ç”¨å¤šè¿›ç¨‹ open æˆ–è€…å¤šè¿›ç¨‹ mmap åˆ°ä¸€ä¸ªå…±åŒçš„ tmpfs æ–‡ä»¶è¾¾åˆ°è¿›ç¨‹é—´é€šä¿¡çš„æ•ˆæœ 1 2 3 int fd = open(\"example.txt\", O_RDONLY); char *mapped = mmap(NULL, 4096, PROT_READ, MAP_PRIVATE, fd, 0); close(fd); è§‚å¯ŸçœŸå®æœºå™¨ä¸Šçš„ tmpfs 1 2 3 4 5 6 7 8 9 10 11 12 13 14 hcy@debian:~$ df -h æ–‡ä»¶ç³»ç»Ÿ å¤§å° å·²ç”¨ å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹ udev 32G 0 32G 0% /dev tmpfs 6.3G 1.9M 6.3G 1% /run /dev/sdb1 119G 29G 91G 25% / tmpfs 32G 550M 31G 2% /dev/shm tmpfs 5.0M 12K 5.0M 1% /run/lock tmpfs 32G 96M 32G 1% /tmp /dev/sdb2 300M 5.9M 294M 2% /boot/efi /dev/sda2 900G 218G 682G 25% /mnt/146bf4b9-b9ad-486d-811c-dcbb31aa3324 tmpfs 6.3G 256K 6.3G 1% /run/user/1000 hcy@debian:~$ id hcy uid=1000(hcy) gid=1000(hcy) ç»„=1000(hcy), ... åœ¨ä¸Šé¢çš„ df -h è¾“å‡ºä¸­ï¼Œåˆ—å‡ºäº†å¤šä¸ª tmpfs æŒ‚è½½ç‚¹ /run: tmpfs è¢«æŒ‚è½½åœ¨ /run ç›®å½•ã€‚å®ƒæ˜¯ä¸€ä¸ªåŠ¨æ€çš„ã€çŸ­æœŸçš„æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨ç³»ç»Ÿè¿è¡Œæ—¶çš„æ•°æ®ï¼ˆå¦‚è¿›ç¨‹ ID æ–‡ä»¶ã€é”æ–‡ä»¶ç­‰ï¼‰\n/dev/shm: tmpfs è¢«æŒ‚è½½åœ¨ /dev/shm ç›®å½•ï¼Œå®ƒæ˜¯å…±äº«å†…å­˜çš„æŒ‚è½½ç‚¹ï¼Œä¾›è¿›ç¨‹é—´é€šä¿¡ä½¿ç”¨\n/run/lock: tmpfs è¢«æŒ‚è½½åœ¨ /run/lock ç›®å½•ï¼Œç”¨äºå­˜æ”¾è¿›ç¨‹é—´é”æ–‡ä»¶\n/tmp: tmpfs è¢«æŒ‚è½½åœ¨ /tmp ç›®å½•ï¼Œç”¨äºå­˜æ”¾ä¸´æ—¶æ–‡ä»¶\n/run/user/1000: è¯¥ tmpfs æ˜¯ä¸ºç”¨æˆ· ID ä¸º 1000 çš„ç”¨æˆ·ï¼ˆä¹Ÿå°±æ˜¯ç”¨æˆ· hcy ï¼‰æä¾›çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚ç¨‹åºç¼“å­˜ã€ä¸´æ—¶æ–‡ä»¶ç­‰\nè¿™äº› tmpfs æŒ‚è½½ç‚¹çš„æ•°æ®åœ¨æœºå™¨é‡å¯ä¹‹åéƒ½ä¸ä¼šå­˜åœ¨ è§‚å¯Ÿå®¹å™¨é‡Œé¢çš„ tmpfs åœ¨ Docker ä¸­ï¼Œå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯åŸºäº UnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰çš„ï¼Œé€šå¸¸é‡‡ç”¨çš„æ˜¯ aufsã€overlay æˆ– overlay2 ç­‰æ–‡ä»¶ç³»ç»Ÿï¼Œè€ŒUnionFS å¹¶ä¸ç›´æ¥ä½¿ç”¨ tmpfsï¼Œé™¤éæ˜ç¡®å°†æŸäº›ç›®å½•æŒ‚è½½ä¸º tmpfs Docker å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯æŒä¹…åŒ–çš„ï¼Œåœ¨å®¹å™¨ä¸­æ–‡ä»¶å­˜å‚¨åœ¨é•œåƒå±‚ read-only layer å’Œå®¹å™¨å±‚ read-write layer ä¸Š é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å®¹å™¨é‡å¯æ—¶ï¼Œå®¹å™¨å±‚ä¼šä¿æŒä¸å˜ï¼Œå³ä½¿å†™å…¥åˆ° /tmp ç›®å½•çš„æ–‡ä»¶ï¼Œéƒ½ä¼šä¿å­˜åœ¨å®¹å™¨å±‚ä¸­ï¼Œè€Œä¸æ˜¯ä¸¢å¤± åªæœ‰åœ¨å®¿ä¸»æœºå±‚é¢åœ¨å®¹å™¨åˆ›å»ºæ—¶ï¼Œé€šè¿‡ --tmpfs å‚æ•°æ¥æŒ‡å®šå°† /tmp æŒ‚è½½ä¸º tmpfsï¼Œæ‰æœ‰å¯èƒ½è®©å®¹å™¨é‡Œé¢çš„ /tmp çš„è¡¨ç°å’Œå¸¸è§„çš„ä¸€æ · 1 docker run --tmpfs /tmp å…¨å±€å…±äº«çš„é›¶é¡µï¼ˆglobal zero pageï¼‰ Linux å†…æ ¸ä¸­æœ‰ä¸€ä¸ªå…¨å±€å…±äº«çš„é›¶é¡µï¼Œæ‰€æœ‰å­—èŠ‚éƒ½è¢«åˆå§‹åŒ–ä¸ºé›¶ï¼Œè¿™å—å†…å­˜é¡µè¢«å…¨å±€æ‰€æœ‰è¿›ç¨‹å…±äº«ï¼Œé€šå¸¸æ˜¯åªè¯»çš„ï¼Œå¤šè¿›ç¨‹å¯ä»¥åŒæ—¶è®¿é—® å½“ä¸€ä¸ªè¿›ç¨‹éœ€è¦è®¿é—®å¤§é‡çš„å…¨é›¶æ•°æ®ï¼ˆå¦‚æœªåˆå§‹åŒ–çš„å†…å­˜ã€æ‰©å±•æ–‡ä»¶çš„ç©ºç™½éƒ¨åˆ†ï¼‰ï¼Œå¯ä»¥ç›´æ¥æ˜ å°„åˆ°å…¨å±€é›¶é¡µï¼Œè€Œæ— éœ€å®é™…åˆ†é…å’Œåˆå§‹åŒ–ç‰©ç†å†…å­˜ï¼Œé¿å…ä¸ºæ¯ä¸ªè¿›ç¨‹å•ç‹¬åˆ†é…ä¸€å—å…¨é›¶çš„å†…å­˜é¡µ ä¾‹å¦‚å½“æ–‡ä»¶é€šè¿‡ truncate() æ‰©å±•æ—¶ï¼Œæ–°å¢åŠ çš„éƒ¨åˆ†éœ€è¦åˆå§‹åŒ–ä¸ºé›¶ã€‚å¦‚æœç›´æ¥å†™é›¶åˆ°ç£ç›˜æˆ–å†…å­˜ï¼Œä¼šæ¶ˆè€—èµ„æº é€šè¿‡å…¨å±€é›¶é¡µï¼Œæ–‡ä»¶ç³»ç»Ÿå¯ä»¥å°†æ–°å¢åŠ çš„éƒ¨åˆ†æ˜ å°„åˆ°è¿™å—é›¶é¡µï¼Œè€Œä¸éœ€è¦å®é™…åˆ†é…å’Œåˆå§‹åŒ– åˆä¾‹å¦‚è¿›ç¨‹åˆ†é…å†…å­˜æ—¶ï¼Œæœªä½¿ç”¨çš„éƒ¨åˆ†ï¼ˆä¾‹å¦‚é€šè¿‡ mmap æ˜ å°„çš„åŒ¿åå†…å­˜ï¼‰é€šå¸¸è¢«æ˜ å°„ä¸ºé›¶é¡µï¼Œç›´åˆ°å®é™…å†™å…¥æ•°æ®ä¸ºæ­¢ ç”±äºé›¶é¡µæ˜¯åªè¯»çš„ï¼Œå¦‚æœè¿›ç¨‹è¯•å›¾å†™å…¥é›¶é¡µï¼Œä¼šè§¦å‘é¡µé”™è¯¯ page faultï¼Œå†…æ ¸ä¼šå¤åˆ¶ä¸€å—æ–°çš„ç‰©ç†é¡µä¾›è¿›ç¨‹ä½¿ç”¨ï¼Œè¿™å«åšâ€œå†™æ—¶å¤åˆ¶â€ Copy-on-Write, COW ","wordCount":"1682","inLanguage":"zh","image":"https://hcy-asleep.github.io/","datePublished":"2024-11-30T19:35:39Z","dateModified":"2024-11-30T19:35:39Z","author":{"@type":"Person","name":"HCY"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hcy-asleep.github.io/Linux-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%BB%A5%E5%8F%8A%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/"},"publisher":{"@type":"Organization","name":"Memos","logo":{"@type":"ImageObject","url":"https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/hcy_site_favicon.png"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://hcy-asleep.github.io/ accesskey=h title="ä¸»é¡µ (Alt + H)">ä¸»é¡µ</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://hcy-asleep.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://hcy-asleep.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://hcy-asleep.github.io/categories/ title=ç›®å½•><span>ç›®å½•</span></a></li><li><a href=https://hcy-asleep.github.io/friends/ title=å‹é“¾><span>å‹é“¾</span></a></li><li><a href=https://hcy-asleep.github.io/todo/ title=TODO><span>TODO</span></a></li><li><a href=https://hcy-asleep.github.io/about/ title=å…³äº><span>å…³äº</span></a></li><li><a href=https://hcy-asleep.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hcy-asleep.github.io/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://hcy-asleep.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Linux è™šæ‹Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜</h1><div class=post-meta><span title='2024-11-30 19:35:39 +0000 UTC'>åä¸€æœˆ 30, 2024</span>&nbsp;Â·&nbsp;8 åˆ†é’Ÿ&nbsp;Â·&nbsp;1682 å­—&nbsp;Â·&nbsp;HCY&nbsp;|&nbsp;<a href=https://github.com/HCY-ASLEEP rel="noopener noreferrer" target=_blank> Follow me</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#linux-å“²å­¦>Linux å“²å­¦</a></li><li><a href=#vmavirtual-memory-area>VMAï¼ˆvirtual memory areaï¼‰</a></li><li><a href=#struct-address_space><code>struct address_space</code></a></li><li><a href=#æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ç±»å‹page-çš„åˆ’åˆ†>æ–‡ä»¶ç³»ç»Ÿã€æ–‡ä»¶ç±»å‹ã€<code>page</code> çš„åˆ’åˆ†</a></li><li><a href=#page-cache-ä¸-swap-cache><code>page cache</code> ä¸ <code>swap cache</code></a></li><li><a href=#ç¡¬ç›˜ç‰©ç†æ–‡ä»¶ç³»ç»Ÿ>ç¡¬ç›˜ï¼ˆç‰©ç†ï¼‰æ–‡ä»¶ç³»ç»Ÿ</a><ul><li><a href=#dentryç›®å½•é¡¹><code>dentry</code>ï¼ˆç›®å½•é¡¹ï¼‰</a></li><li><a href=#inodeç´¢å¼•èŠ‚ç‚¹><code>inode</code>ï¼ˆç´¢å¼•èŠ‚ç‚¹ï¼‰</a></li><li><a href=#i_nlink><code>i_nlink</code></a></li><li><a href=#dentry-å’Œ-inode-çš„å…³ç³»><code>dentry</code> å’Œ <code>inode</code> çš„å…³ç³»</a></li><li><a href=#ç”¨-dentry-æ„å»ºå¤šå‰æ ‘æ–‡ä»¶ç³»ç»Ÿ>ç”¨ <code>dentry</code> æ„å»ºâ€œå¤šå‰æ ‘â€æ–‡ä»¶ç³»ç»Ÿ</a></li><li><a href=#åˆ é™¤ç›®å½•>åˆ é™¤ç›®å½•</a></li></ul></li><li><a href=#tmpfs-ä¸-shm-è”ç³»><code>tmpfs</code> ä¸ <code>shm</code> è”ç³»</a><ul><li><a href=#shm-introduction><code>shm</code> introduction</a></li><li><a href=#tmpfs-introduction><code>tmpfs</code> introduction</a></li><li><a href=#tmpfs-çš„æ ¸å¿ƒå®ç°æºè‡ªäº-shm><code>tmpfs</code> çš„æ ¸å¿ƒå®ç°æºè‡ªäº <code>shm</code></a></li></ul></li><li><a href=#shm-ä½¿ç”¨><code>shm</code> ä½¿ç”¨</a></li><li><a href=#tmpfs-ä½¿ç”¨><code>tmpfs</code> ä½¿ç”¨</a><ul><li><a href=#è§‚å¯ŸçœŸå®æœºå™¨ä¸Šçš„-tmpfs>è§‚å¯ŸçœŸå®æœºå™¨ä¸Šçš„ <code>tmpfs</code></a></li><li><a href=#è§‚å¯Ÿå®¹å™¨é‡Œé¢çš„-tmpfs>è§‚å¯Ÿå®¹å™¨é‡Œé¢çš„ <code>tmpfs</code></a></li></ul></li><li><a href=#å…¨å±€å…±äº«çš„é›¶é¡µglobal-zero-page>å…¨å±€å…±äº«çš„é›¶é¡µï¼ˆglobal zero pageï¼‰</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>æœ€è¿‘çœ‹äº†<a href=https://pdos.csail.mit.edu/~sbw/links/gorman_book.pdf>ã€ŠUnderstanding the LinuxÂ® Virtual Memory Managerã€‹</a>é‡Œé¢çš„ç¬¬åäºŒç«  <strong>SHARED MEMORY VIRTUAL FILESYSTEM</strong> ï¼Œå¯¹æ–‡ä»¶ç³»ç»Ÿä»¥åŠå†…å­˜æ–‡ä»¶ç®¡ç†æœ‰äº†æ›´åŠ æ·±å…¥çš„äº†è§£ï¼Œä¸‹é¢æ˜¯çœ‹äº†è¿™ä¸€ç« èŠ‚ä¹‹åå¯¹å…¶ä¸­ä¸€äº›æ¦‚å¿µçš„ç†è§£ä»¥åŠæ‹“å±•ï¼Œè¦æ˜¯æƒ³äº†è§£è¿™ä¸€ç« ï¼Œ<a href=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/gordan-book-linux-vmm12-chap.pdf>å»ºè®®è¯»åŸæ–‡</a>ï¼Œé…åˆè¿™ç¯‡åšå®¢è¾…åŠ©ç†è§£</p><h2 id=linux-å“²å­¦>Linux å“²å­¦<a hidden class=anchor aria-hidden=true href=#linux-å“²å­¦>#</a></h2><ul><li>åœ¨ Linux é‡Œé¢ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½å¯ä»¥çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œå‡¡æ˜¯æ–‡ä»¶ï¼Œéƒ½åº”è¯¥æ”¯æŒæˆ–è€…æ¥è¿‘<code>POSIX</code>æ–‡ä»¶æ“ä½œï¼ˆæ¯”å¦‚ <code>read()</code> ï¼Œ<code>write()</code> ï¼Œ<code>open()</code>ï¼‰</li><li>æ¯ä¸€å—å†…å­˜å¯¹è±¡ï¼Œéƒ½å¯ä»¥è¢«çœ‹ä½œä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€æ—¦èµ‹äºˆè¿™å—å†…å­˜å¯¹è±¡ç›¸å¯¹åº”çš„æ–‡ä»¶æè¿°ï¼Œå°±å¯ä»¥ä½¿ç”¨åƒä½¿ç”¨æ™®é€šæ–‡ä»¶é‚£æ ·å­æ“ä½œå†…å­˜å¯¹è±¡</li><li>è€Œè¿™ä¹Ÿæ­£æ˜¯ <code>VFS</code>ï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ <code>virtual file system</code> ï¼ŒåŒ…æ‹¬å†…å­˜æ–‡ä»¶ç³»ç»Ÿä»¥åŠå…±äº«å†…å­˜ç®¡ç†ç³»ç»Ÿï¼‰çš„è®¾è®¡ç†å¿µä»¥åŠå®ç°æ–¹å‘</li></ul><h2 id=vmavirtual-memory-area>VMAï¼ˆvirtual memory areaï¼‰<a hidden class=anchor aria-hidden=true href=#vmavirtual-memory-area>#</a></h2><ul><li><p>Linux å†…æ ¸ç”¨<code>vm_area_struct</code>ç»“æ„ä½“æè¿°æŸä¸€æ®µè¿ç»­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ <code>VMAï¼ˆvirtual memory areaï¼‰</code>ï¼Œæ¯ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸ <code>VMA</code> éƒ½æœ‰è‡ªå·±çš„<code>vm_area_struct</code> ç»“æ„ä½“</p></li><li><p>å†…å­˜æè¿°ç¬¦ <code>mm_struct</code> æŒ‡å‘è¿›ç¨‹çš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œ<code>vm_area_struct</code> åªæ˜¯æŒ‡å‘äº†è™šæ‹Ÿç©ºé—´çš„ä¸€æ®µï¼Œè¿™å—è™šæ‹Ÿå†…å­˜åŒºåŸŸVMAçš„åœ°å€èŒƒå›´ä¸º <code>[vm_start, vm_end)</code> ï¼Œå·¦å¼€å³é—­
<img src=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/v2-426557bb4eb1e7044bd649483942c2ad_r.jpg width=55%></p></li><li><p><code>vm_area_struct</code> æ˜¯ç”±åŒå‘é“¾è¡¨é“¾æ¥èµ·æ¥çš„ï¼Œå®ƒä»¬æ˜¯æŒ‰ç…§è™šæ‹Ÿåœ°å€é™åºæ’åºçš„ï¼Œæ¯ä¸ªè¿™æ ·çš„ç»“æ„éƒ½å¯¹åº”æè¿°ä¸€ä¸ªåœ°å€ç©ºé—´èŒƒå›´</p></li><li><p>ä¸ºäº†å¿«é€Ÿæ ¹æ®åœ°å€æ‰¾åˆ°å¯¹åº”çš„ <code>VMA</code>ï¼Œå†…æ ¸å¯¹å…¶å»ºç«‹äº†çº¢é»‘æ ‘ç´¢å¼•ï¼Œçº¢é»‘æ ‘çš„æ¯ä¸ªå¶å­ç»“ç‚¹å°±æ˜¯ä¸€ä¸ªVMAåŒºåŸŸï¼Œå¼•å…¥çº¢é»‘æ ‘çš„å¥½å¤„æ˜¯å¯ä»¥æé«˜æŸ¥æ‰¾VMAçš„æ•ˆç‡ï¼ˆå³ä¾¿VMAçš„æ•°é‡ç¿»å€ï¼ŒVMAçš„æŸ¥æ‰¾æ¬¡æ•°ä¹Ÿåªå¢åŠ ä¸€æ¬¡ï¼‰
<input type=checkbox id=zoomCheck-b4749 hidden>
<label for=zoomCheck-b4749><img class=zoomCheck loading=lazy decoding=async src=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/v2-82dec5bde95009f934d3978c15412626_1440w.jpg alt></label></p></li><li><p>ä¹‹æ‰€ä»¥é€šè¿‡ <code>VMA</code> åˆ†éš”å†…å­˜åŒºåŸŸæ˜¯å› ä¸ºæ¯ä¸ªè™šæ‹ŸåŒºé—´å¯èƒ½æ¥æºä¸åŒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå¯æ‰§è¡Œæ˜ åƒï¼Œæœ‰çš„å¯èƒ½æ¥è‡ªå…±äº«åº“ï¼Œè€Œæœ‰çš„å¯èƒ½æ˜¯åŠ¨æ€å†…å­˜åˆ†é…çš„å†…å­˜åŒºï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸ªç”± <code>vm_area_struct</code> ç»“æ„æ‰€æè¿°çš„åŒºé—´çš„å¤„ç†æ“ä½œå’Œå®ƒå‰åèŒƒå›´çš„å¤„ç†æ“ä½œä¸åŒï¼Œå› æ­¤ linux æŠŠè™šæ‹Ÿå†…å­˜åˆ†å‰²ç®¡ç†ï¼Œå¹¶åˆ©ç”¨äº†è™šæ‹Ÿå†…å­˜å¤„ç†ä¾‹ç¨‹ <code>vm_ops</code> æ¥æŠ½è±¡å¯¹ä¸åŒæ¥æºè™šæ‹Ÿå†…å­˜çš„å¤„ç†æ–¹æ³•</p></li><li><p>ä¸åŒçš„è™šæ‹ŸåŒºé—´å…¶å¤„ç†æ“ä½œå¯èƒ½ä¸åŒï¼Œ<code>linux</code> åœ¨è¿™é‡Œåˆ©ç”¨äº†é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œå³æŠŠä¸€ä¸ªè™šæ‹ŸåŒºé—´çœ‹æˆæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨ <code>vm_area_struct</code> æè¿°è¿™ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå…¶ä¸­çš„ <code>vm_operation</code> ç»“æ„æè¿°äº†åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„æ“ä½œ
<input type=checkbox id=zoomCheck-53ba1 hidden>
<label for=zoomCheck-53ba1><img class=zoomCheck loading=lazy decoding=async src=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/v2-ce0aa70282615def188d51d5ee745e14_1440w.jpg alt></label></p></li><li><p>è™šæ‹Ÿå†…å­˜ç©ºé—´ç®¡ç†æ¦‚æ‹¬å›¾
<input type=checkbox id=zoomCheck-a1d4d hidden>
<label for=zoomCheck-a1d4d><img class=zoomCheck loading=lazy decoding=async src=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/v2-410e447557fe925077f0580463875666_r.jpg alt></label></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp># https:</span><span class=c1>//elixir.bootlin.com/linux/v2.6.0/source/include/linux/mm.h#L51
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>vm_area_struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>mm_struct</span> <span class=o>*</span> <span class=n>vm_mm</span><span class=p>;</span>	<span class=cm>/* The address space we belong to. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>vm_start</span><span class=p>;</span>		<span class=cm>/* Our start address within vm_mm. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>vm_end</span><span class=p>;</span>		<span class=cm>/* The first byte after our end address
</span></span></span><span class=line><span class=cl><span class=cm>					   within vm_mm. */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* linked list of VM areas per task, sorted by address */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>vm_area_struct</span> <span class=o>*</span><span class=n>vm_next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>pgprot_t</span> <span class=n>vm_page_prot</span><span class=p>;</span>		<span class=cm>/* Access permissions of this VMA. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>vm_flags</span><span class=p>;</span>		<span class=cm>/* Flags, listed below. */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>rb_node</span> <span class=n>vm_rb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * For areas with an address space and backing store,
</span></span></span><span class=line><span class=cl><span class=cm>	 * one of the address_space-&gt;i_mmap{,shared} lists,
</span></span></span><span class=line><span class=cl><span class=cm>	 * for shm areas, the list of attaches, otherwise unused.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>list_head</span> <span class=n>shared</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Function pointers to deal with this struct. */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>vm_operations_struct</span> <span class=o>*</span> <span class=n>vm_ops</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Information about our backing store: */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>vm_pgoff</span><span class=p>;</span>		<span class=cm>/* Offset (within vm_file) in PAGE_SIZE
</span></span></span><span class=line><span class=cl><span class=cm>					   units, *not* PAGE_CACHE_SIZE */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>file</span> <span class=o>*</span> <span class=n>vm_file</span><span class=p>;</span>		<span class=cm>/* File we map to (can be NULL). */</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span> <span class=n>vm_private_data</span><span class=p>;</span>		<span class=cm>/* was vm_pte (shared mem) */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=struct-address_space><code>struct address_space</code><a hidden class=anchor aria-hidden=true href=#struct-address_space>#</a></h2><ul><li>çœ‹ <code>linux</code> å†…æ ¸å¾ˆå®¹æ˜“è¢« <code>struct address_space</code> è¿™ä¸ªç»“æ„è¿·æƒ‘ï¼Œå®ƒæ˜¯ä»£è¡¨æŸä¸ªåœ°å€ç©ºé—´å—ï¼Ÿå®é™…ä¸Šä¸æ˜¯çš„ï¼Œå®ƒæ˜¯ç”¨äºç®¡ç†æ–‡ä»¶ <code>struct inode</code> æ˜ å°„åˆ°å†…å­˜çš„é¡µé¢ <code>struct page</code> çš„ï¼Œå…¶å®å°±æ˜¯æ¯ä¸ªè¯»å…¥å†…å­˜çš„ <code>file</code> éƒ½æœ‰è¿™ä¹ˆä¸€ä¸ªç»“æ„ï¼Œå°†æ–‡ä»¶ç³»ç»Ÿä¸­è¿™ä¸ª <code>file</code> å¯¹åº”çš„æ•°æ®ä¸è¿™ä¸ª <code>file</code> çš„ç£ç›˜æ•°æ®ä¸å†…å­˜é¡µå¯¹åº”èµ·æ¥</li><li>ä¸ä¹‹å¯¹åº”ï¼Œ<code>address_space_operations</code> å°±æ˜¯ç”¨æ¥æ“ä½œè¯¥æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜çš„é¡µé¢ï¼Œæ¯”å¦‚æŠŠå†…å­˜ä¸­çš„ä¿®æ”¹å†™å›æ–‡ä»¶ã€ä»æ–‡ä»¶ä¸­è¯»å…¥æ•°æ®åˆ°é¡µé¢ç¼“å†²ç­‰
<input type=checkbox id=zoomCheck-40bbb hidden>
<label for=zoomCheck-40bbb><img class=zoomCheck loading=lazy decoding=async src=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/v2-ea46cfd3a0c3770c593db4e4f4dfc597_1440w.jpg alt></label></li><li>ä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶åœ¨æ‰“å¼€åï¼Œå†…æ ¸ä¼šåœ¨å†…å­˜ä¸­ä¸ºä¹‹å»ºç«‹ä¸€ä¸ª <code>struct inode</code> ç»“æ„ï¼ˆè¯¥ <code>inode</code> ç»“æ„ä¹Ÿä¼šåœ¨å¯¹åº”çš„ <code>file</code> ç»“æ„ä½“ä¸­å¼•ç”¨ï¼‰ï¼Œå…¶ä¸­çš„ <code>i_mapping</code> åŸŸæŒ‡å‘ä¸€ä¸ª <code>address_space</code> ç»“æ„</li><li>ä¸€ä¸ªæ–‡ä»¶å°±å¯¹åº”ä¸€ä¸ª <code>address_space</code> ç»“æ„ï¼Œä¸€ä¸ª <code>address_space</code> ä¸ä¸€ä¸ªåç§»é‡èƒ½å¤Ÿç¡®å®šä¸€ä¸ª <code>page cache</code> æˆ– <code>swap cache</code> ä¸­çš„ä¸€ä¸ªé¡µé¢ï¼Œå½“è¦å¯»å€æŸä¸ªæ•°æ®æ—¶ï¼Œå¾ˆå®¹æ˜“æ ¹æ®ç»™å®šçš„æ–‡ä»¶åŠæ•°æ®åœ¨æ–‡ä»¶å†…çš„åç§»é‡è€Œæ‰¾åˆ°ç›¸åº”çš„é¡µé¢</li><li><code>struct file</code> å’Œ <code>struct inode</code> ç»“æ„ä½“ä¸­éƒ½æœ‰ä¸€ä¸ª <code>struct address_space</code> æŒ‡é’ˆ<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp># https:</span><span class=c1>//elixir.bootlin.com/linux/v2.6.0/source/include/linux/fs.h#L319
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>address_space</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>inode</span>		<span class=o>*</span><span class=n>host</span><span class=p>;</span>		<span class=cm>/* owner: inode, block_device */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>radix_tree_root</span>	<span class=n>page_tree</span><span class=p>;</span>	<span class=cm>/* radix tree of all pages */</span>
</span></span><span class=line><span class=cl>	<span class=n>spinlock_t</span>		<span class=n>page_lock</span><span class=p>;</span>	<span class=cm>/* and spinlock protecting it */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>list_head</span>	<span class=n>clean_pages</span><span class=p>;</span>	<span class=cm>/* list of clean pages */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>list_head</span>	<span class=n>dirty_pages</span><span class=p>;</span>	<span class=cm>/* list of dirty pages */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>list_head</span>	<span class=n>locked_pages</span><span class=p>;</span>	<span class=cm>/* list of locked pages */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>list_head</span>	<span class=n>io_pages</span><span class=p>;</span>	<span class=cm>/* being prepared for I/O */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>nrpages</span><span class=p>;</span>	<span class=cm>/* number of total pages */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>address_space_operations</span> <span class=o>*</span><span class=n>a_ops</span><span class=p>;</span>	<span class=cm>/* methods */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>list_head</span>	<span class=n>i_mmap</span><span class=p>;</span>		<span class=cm>/* list of private mappings */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>list_head</span>	<span class=n>i_mmap_shared</span><span class=p>;</span>	<span class=cm>/* list of shared mappings */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>semaphore</span>	<span class=n>i_shared_sem</span><span class=p>;</span>	<span class=cm>/* protect both above lists */</span>
</span></span><span class=line><span class=cl>	<span class=n>atomic_t</span>		<span class=n>truncate_count</span><span class=p>;</span>	<span class=cm>/* Cover race condition with truncate */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>dirtied_when</span><span class=p>;</span>	<span class=cm>/* jiffies of first page dirtying */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>flags</span><span class=p>;</span>		<span class=cm>/* error bits/gfp mask */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>backing_dev_info</span> <span class=o>*</span><span class=n>backing_dev_info</span><span class=p>;</span> <span class=cm>/* device readahead, etc */</span>
</span></span><span class=line><span class=cl>	<span class=n>spinlock_t</span>		<span class=n>private_lock</span><span class=p>;</span>	<span class=cm>/* for use by the address_space */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>list_head</span>	<span class=n>private_list</span><span class=p>;</span>	<span class=cm>/* ditto */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>address_space</span>	<span class=o>*</span><span class=n>assoc_mapping</span><span class=p>;</span>	<span class=cm>/* ditto */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ç±»å‹page-çš„åˆ’åˆ†>æ–‡ä»¶ç³»ç»Ÿã€æ–‡ä»¶ç±»å‹ã€<code>page</code> çš„åˆ’åˆ†<a hidden class=anchor aria-hidden=true href=#æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ç±»å‹page-çš„åˆ’åˆ†>#</a></h2><ul><li>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œåœ¨æ­¤å°†æ–‡ä»¶ç³»ç»Ÿåˆ’åˆ†ä¸ºå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ä¸ç¡¬ç›˜æ–‡ä»¶ç³»ç»Ÿï¼ˆç‰©ç†æ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œåœ¨ä¹¦çš„è¿™ä¸€ç« èŠ‚é‡Œé¢ï¼Œä¹Ÿå°†å¹¿ä¹‰ä¸Šçš„æ–‡ä»¶åˆ†ä¸º <code>virtual file</code> å’Œ <code>physical file</code></li><li>åœ¨ä¹¦çš„è¿™ä¸€ç« èŠ‚é‡Œé¢ï¼Œå°†å†…å­˜é¡µé¢ <code>page</code> åˆ’åˆ†ä¸º <code>anonymous pages</code> ï¼ˆæ²¡æœ‰ç‰©ç†æ–‡ä»¶æ”¯æŒçš„å†…å­˜é¡µé¢ï¼‰ä¸ <code>pages backed by a file</code>ï¼ˆç”±ç‰©ç†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜çš„æŸäº› <code>pages</code>ï¼‰</li></ul><h2 id=page-cache-ä¸-swap-cache><code>page cache</code> ä¸ <code>swap cache</code><a hidden class=anchor aria-hidden=true href=#page-cache-ä¸-swap-cache>#</a></h2><ul><li><code>page cache</code> æ˜¯ä¸æ–‡ä»¶æ˜ å°„å¯¹åº”çš„ï¼Œè€Œ <code>swap cache</code> æ˜¯ä¸åŒ¿åé¡µå¯¹åº”çš„</li><li>å¦‚æœä¸€ä¸ªå†…å­˜é¡µé¢ä¸æ˜¯æ–‡ä»¶æ˜ å°„ï¼Œåˆ™åœ¨æ¢å…¥æ¢å‡ºçš„æ—¶å€™åŠ å…¥åˆ° <code>swap cache</code> ï¼Œå¦‚æœæ˜¯æ–‡ä»¶æ˜ å°„ï¼Œåˆ™ä¸éœ€è¦äº¤æ¢ç¼“å†²</li><li>è¿™ä¸¤ä¸ªçš„ç›¸åŒç‚¹å°±æ˜¯å®ƒä»¬éƒ½æ˜¯ <code>address_space</code> ï¼Œéƒ½æœ‰ç›¸å¯¹åº”çš„æ–‡ä»¶æ“ä½œï¼šä¸€ä¸ªè¢«è®¿é—®çš„æ–‡ä»¶çš„ç‰©ç†é¡µé¢éƒ½é©»ç•™åœ¨ <code>page cache</code> æˆ– <code>swap cache</code> ä¸­ï¼Œä¸€ä¸ªé¡µé¢çš„æ‰€æœ‰ä¿¡æ¯ç”± <code>struct page</code> æ¥æè¿°</li><li><code>page cache</code> ä½œç”¨<ul><li>å½“æ–‡ä»¶è¢«è¯»å–æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠæ–‡ä»¶å†…å®¹åŠ è½½åˆ°å†…å­˜çš„ <code>page cache</code> ä¸­</li><li>å¦‚æœåŒä¸€ä¸ªæ–‡ä»¶è¢«å†æ¬¡è®¿é—®ï¼Œæ“ä½œç³»ç»Ÿä¼šç›´æ¥ä» <code>page cache</code> ä¸­è¯»å–ï¼Œè€Œä¸æ˜¯å†æ¬¡ä»ç£ç›˜è¯»å–ï¼Œä»è€Œå‡å°‘ç£ç›˜è®¿é—®æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½</li></ul></li><li><code>swap cache</code> ä½œç”¨<ul><li><code>swap cache</code> ç¼“å­˜çš„æ˜¯å·²ç»äº¤æ¢åˆ°ç£ç›˜çš„æ•°æ®ï¼Œå®ƒæ˜¯ä¸ºäº†æé«˜äº¤æ¢æ“ä½œçš„æ•ˆç‡ï¼Œä¼˜åŒ–è™šæ‹Ÿå†…å­˜çš„äº¤æ¢æ“ä½œ</li><li>å¦‚æœå†…å­˜ä¸­å†æ¬¡éœ€è¦ä½¿ç”¨è¿™äº›é¡µé¢ï¼Œæ“ä½œç³»ç»Ÿä¼šä» <code>swap cache</code> é‡Œé¢å¯»æ‰¾ï¼Œç„¶åå†ä» <code>swap</code> é‡Œé¢æŸ¥æ‰¾</li><li>åŒæ—¶å¯¹äºé‚£äº›åˆšåˆšä»ç‰©ç†å†…å­˜é‡Œé¢æ¢å‡ºæ¥çš„ <code>page</code> ä»¥åŠä» <code>swap</code> ç©ºé—´è¯»å–çš„ <code>page</code> ä¹Ÿä¼šæ”¾åœ¨ <code>swap cache</code> é‡Œé¢</li></ul></li><li>ä¸€èˆ¬æƒ…å†µä¸‹ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ <code>mmap()</code> æ—¶ï¼Œåªæ˜¯åœ¨è¿›ç¨‹ç©ºé—´å†…æ–°å¢äº†ä¸€å—ç›¸åº”å¤§å°çš„ç¼“å†²åŒºï¼Œå¹¶è®¾ç½®äº†ç›¸åº”çš„è®¿é—®æ ‡è¯†ï¼Œä½†å¹¶æ²¡æœ‰å»ºç«‹è¿›ç¨‹ç©ºé—´åˆ°ç‰©ç†é¡µé¢çš„æ˜ å°„</li><li>å› æ­¤ï¼Œç¬¬ä¸€æ¬¡è®¿é—®è¯¥ç©ºé—´æ—¶ï¼Œä¼šå¼•å‘ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸</li><li>å¯¹äºå…±äº«å†…å­˜æ˜ å°„æƒ…å†µ<ul><li>ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºé¦–å…ˆåœ¨ <code>swap cache</code> ä¸­å¯»æ‰¾ç›®æ ‡é¡µï¼ˆç¬¦åˆ <code>address_space</code> ä»¥åŠåç§»é‡çš„ç‰©ç†é¡µï¼‰</li><li>å¦‚æœæ‰¾åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›åœ°å€</li><li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™åˆ¤æ–­è¯¥é¡µæ˜¯å¦åœ¨äº¤æ¢åŒº (<code>swap area</code>)ï¼Œå¦‚æœåœ¨ï¼Œåˆ™æ‰§è¡Œä¸€ä¸ªæ¢å…¥æ“ä½œ</li><li>å¦‚æœä¸Šè¿°ä¸¤ç§æƒ…å†µéƒ½ä¸æ»¡è¶³ï¼Œå¤„ç†ç¨‹åºå°†åˆ†é…æ–°çš„ç‰©ç†é¡µé¢ï¼Œå¹¶æŠŠå®ƒæ’å…¥åˆ° <code>page cache</code> ä¸­ï¼Œæœ€ç»ˆå°†æ›´æ–°è¿›ç¨‹é¡µè¡¨</li></ul></li><li>å¯¹äºæ˜ å°„æ™®é€šæ–‡ä»¶æƒ…å†µï¼ˆéå…±äº«æ˜ å°„ï¼‰<ul><li>ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºé¦–å…ˆä¼šåœ¨ <code>page cache</code> ä¸­æ ¹æ® <code>address_space</code> ä»¥åŠæ•°æ®åç§»é‡å¯»æ‰¾ç›¸åº”çš„é¡µé¢</li><li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¯´æ˜æ–‡ä»¶æ•°æ®è¿˜æ²¡æœ‰è¯»å…¥å†…å­˜ï¼Œå¤„ç†ç¨‹åºä¼šä»ç£ç›˜è¯»å…¥ç›¸åº”çš„é¡µé¢ï¼Œå¹¶è¿”å›ç›¸åº”åœ°å€ï¼ŒåŒæ—¶è¿›ç¨‹é¡µè¡¨ä¹Ÿä¼šæ›´æ–°</li></ul></li></ul><h2 id=ç¡¬ç›˜ç‰©ç†æ–‡ä»¶ç³»ç»Ÿ>ç¡¬ç›˜ï¼ˆç‰©ç†ï¼‰æ–‡ä»¶ç³»ç»Ÿ<a hidden class=anchor aria-hidden=true href=#ç¡¬ç›˜ç‰©ç†æ–‡ä»¶ç³»ç»Ÿ>#</a></h2><p>åœ¨ Linux æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ<code>dentry</code>ï¼ˆç›®å½•é¡¹ï¼‰å’Œ <code>inode</code>ï¼ˆç´¢å¼•èŠ‚ç‚¹ï¼‰æ˜¯ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒä»¬æ˜¯æ–‡ä»¶ç³»ç»Ÿå†…éƒ¨ç”¨äºè¡¨ç¤ºå’Œç®¡ç†æ–‡ä»¶ã€ç›®å½•åŠå…¶å±æ€§çš„æ•°æ®ç»“æ„</p><h3 id=dentryç›®å½•é¡¹><code>dentry</code>ï¼ˆç›®å½•é¡¹ï¼‰<a hidden class=anchor aria-hidden=true href=#dentryç›®å½•é¡¹>#</a></h3><ul><li><code>dentry</code> æ˜¯ä¸€ä¸ª <code>ç›®å½•é¡¹</code> çš„æ•°æ®ç»“æ„ï¼Œå®ƒè¡¨ç¤ºæ–‡ä»¶<code>è·¯å¾„å</code>ä¸æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„<code>ä½ç½®</code>ä¹‹é—´çš„æ˜ å°„å…³ç³»</li><li>æ¯ä¸ª <code>dentry</code> å…³è”äº†ä¸€ä¸ªè·¯å¾„ç»„ä»¶ï¼ˆå¦‚æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶åï¼‰ï¼Œå¹¶æŒ‡å‘æ–‡ä»¶ç³»ç»Ÿä¸­çš„ <code>inode</code>ï¼Œå†…æ ¸é€šè¿‡é€çº§è§£æè·¯å¾„æ¥æŸ¥æ‰¾æ–‡ä»¶<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>dentry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=p>......</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>inode</span>  <span class=o>*</span> <span class=n>d_inode</span><span class=p>;</span>	<span class=cm>/* Where the name belongs to - NULL is negative */</span>
</span></span><span class=line><span class=cl>  	<span class=p>......</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span> <span class=n>d_child</span><span class=p>;</span>	<span class=cm>/* child of parent list */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span> <span class=n>d_subdirs</span><span class=p>;</span>	<span class=cm>/* our children */</span>
</span></span><span class=line><span class=cl>  	<span class=p>......</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>qstr</span> <span class=n>d_name</span><span class=p>;</span> <span class=cm>/* file name */</span>
</span></span><span class=line><span class=cl>  	<span class=p>......</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>qstr</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>hash</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>name_str</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=inodeç´¢å¼•èŠ‚ç‚¹><code>inode</code>ï¼ˆç´¢å¼•èŠ‚ç‚¹ï¼‰<a hidden class=anchor aria-hidden=true href=#inodeç´¢å¼•èŠ‚ç‚¹>#</a></h3><ul><li><code>inode</code> æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­ç”¨äºæè¿°æ–‡ä»¶æˆ–ç›®å½•çš„å…ƒæ•°æ®çš„æ•°æ®ç»“æ„ï¼Œæ˜¯æ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œé™¤äº†æ–‡ä»¶åä¹‹å¤–ï¼Œå®ƒåŒ…å«äº†æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š<ul><li>æ–‡ä»¶ç±»å‹ï¼ˆæ™®é€šæ–‡ä»¶ã€ç›®å½•ã€ç¬¦å·é“¾æ¥ç­‰ï¼‰</li><li>æ–‡ä»¶æƒé™ï¼ˆè¯»ã€å†™ã€æ‰§è¡Œæƒé™ï¼‰</li><li>æ–‡ä»¶æ‰€æœ‰è€…å’Œç”¨æˆ·ç»„</li><li>æ–‡ä»¶å¤§å°</li><li>æ–‡ä»¶çš„æ—¶é—´æˆ³ï¼ˆåˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´ã€è®¿é—®æ—¶é—´ï¼‰</li><li>æ–‡ä»¶æ•°æ®å—çš„ä½ç½®ï¼ˆæŒ‡å‘æ•°æ®å—çš„æŒ‡é’ˆï¼‰ï¼ŒåŒ…æ‹¬ç›´æ¥å—æŒ‡é’ˆ <code>i_direct</code> ä¸é—´æ¥å—æŒ‡é’ˆ <code>i_indirect</code>
<input type=checkbox id=zoomCheck-9e829 hidden>
<label for=zoomCheck-9e829><img class=zoomCheck loading=lazy decoding=async src=https://raw.githubusercontent.com/HCY-ASLEEP/picture-bed/main/picture-bed/474a5adb633c970271b49623e4cad41b.png alt></label></li></ul></li><li><code>inode</code> æŒ‡å‘æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†ä½ç½®ï¼Œå¸®åŠ©æ“ä½œç³»ç»Ÿå®šä½æ–‡ä»¶æ•°æ®å—ï¼Œä»è€Œå®ç°æ–‡ä»¶çš„è¯»å–å’Œå†™å…¥</li></ul><h3 id=i_nlink><code>i_nlink</code><a hidden class=anchor aria-hidden=true href=#i_nlink>#</a></h3><ul><li><code>i_nlink</code> æ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨ <code>inode</code> ç»“æ„ä¸­çš„å­—æ®µï¼Œè¡¨ç¤ºæŒ‡å‘è¯¥ <code>inode</code> çš„ç¡¬é“¾æ¥æ•°é‡</li><li>å¯¹äºæ™®é€šæ–‡ä»¶<ul><li><code>i_nlink</code> è®°å½•çš„æ˜¯æŒ‡å‘è¯¥æ–‡ä»¶çš„ç¡¬é“¾æ¥æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ–‡ä»¶çš„ <code>i_nlink</code> æ˜¯è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªç›®å½•é¡¹æŒ‡å‘è¯¥æ–‡ä»¶çš„ <code>inode</code></li><li>æ¯å½“åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šä¸ºè¯¥æ–‡ä»¶åˆ†é…ä¸€ä¸ª <code>inode</code>,è€Œæ–‡ä»¶çš„ <code>i_nlink</code> åˆå§‹å€¼ä¸º 1ï¼Œè¿™ä¸ª <code>1</code> ä»£è¡¨ç€è‡ªå·±</li></ul></li><li>å¯¹äºç›®å½•<ul><li><code>i_nlink</code> è®°å½•çš„æ˜¯æŒ‡å‘è¯¥ç›®å½•çš„ç¡¬é“¾æ¥æ•°ï¼Œå®ƒçš„å€¼è¿˜ä¸å­ç›®å½•çš„å­˜åœ¨æœ‰å…³</li><li>æ¯åˆ›å»ºä¸€ä¸ªå­ç›®å½•ï¼Œçˆ¶ç›®å½•çš„ <code>i_nlink</code> ä¼šå¢åŠ </li><li>æ¯ä¸ªå­ç›®å½•çš„ <code>inode</code> è¢«åˆ›å»ºæ—¶ï¼Œçˆ¶ç›®å½•çš„ <code>nlink</code> ä¼šå¢åŠ  1ï¼Œå› ä¸ºå­ç›®å½•ä¼šæœ‰ä¸€ä¸ªæŒ‡å‘çˆ¶ç›®å½•çš„ç¡¬é“¾æ¥ï¼ˆå³ <code>..</code> é“¾æ¥ï¼‰</li></ul></li></ul><h3 id=dentry-å’Œ-inode-çš„å…³ç³»><code>dentry</code> å’Œ <code>inode</code> çš„å…³ç³»<a hidden class=anchor aria-hidden=true href=#dentry-å’Œ-inode-çš„å…³ç³»>#</a></h3><ul><li>å…³è”æ€§<ul><li>æ¯ä¸ª <code>dentry</code> å¯¹åº”ä¸€ä¸ªè·¯å¾„ç»„ä»¶ï¼ˆä¾‹å¦‚æŸä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„åç§°ï¼‰ï¼Œå¹¶ä¸”æ¯ä¸ª <code>dentry</code> éƒ½æŒ‡å‘ä¸€ä¸ª <code>inode</code></li><li>é€šè¿‡ <code>inode</code>ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥æ‰¾åˆ°æ–‡ä»¶çš„å®é™…æ•°æ®ï¼Œè€Œ <code>dentry</code> åˆ™æ˜¯é€šè¿‡æ–‡ä»¶åæ¥æŒ‡å‘ <code>inode</code></li><li>æ¢å¥è¯è¯´ï¼Œ<code>dentry</code> æä¾›äº†æ–‡ä»¶è·¯å¾„åˆ°æ–‡ä»¶æ•°æ®ä½ç½®ï¼ˆå³ <code>inode</code>ï¼‰çš„æ˜ å°„å…³ç³»</li></ul></li><li>è·¯å¾„è§£æ<ul><li>å½“ä¸€ä¸ªè·¯å¾„è¢«è®¿é—®æ—¶ï¼Œå†…æ ¸ä¼šé€æ­¥è§£æè·¯å¾„ä¸­çš„æ¯ä¸ªç›®å½•é¡¹ï¼ˆ<code>dentry</code>ï¼‰ï¼Œé€šè¿‡ç›®å½•é¡¹æ‰¾åˆ°å¯¹åº”çš„ <code>inode</code></li><li>æ¯ä¸ªç›®å½•é¡¹ï¼ˆ<code>dentry</code>ï¼‰éƒ½å­˜å‚¨äº†ä¸€ä¸ªæŒ‡å‘å¯¹åº” <code>inode</code> çš„æŒ‡é’ˆ</li><li>å½“æœ€ç»ˆè§£æåˆ°æ–‡ä»¶åæ—¶ï¼Œå†…æ ¸é€šè¿‡è¯¥ <code>inode</code> è·å–æ–‡ä»¶çš„å…ƒæ•°æ®å¹¶å®šä½æ–‡ä»¶æ•°æ®å—</li></ul></li><li>ç¼“å­˜æœºåˆ¶<ul><li>ä¸ºäº†æé«˜æ€§èƒ½ï¼Œå†…æ ¸ä¼šç¼“å­˜è·¯å¾„åå’Œ <code>inode</code> ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œè¿™æ ·åœ¨è®¿é—®åŒä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•æ—¶ï¼Œå¯ä»¥é¿å…é‡å¤è§£æè·¯å¾„</li></ul></li></ul><h3 id=ç”¨-dentry-æ„å»ºå¤šå‰æ ‘æ–‡ä»¶ç³»ç»Ÿ>ç”¨ <code>dentry</code> æ„å»ºâ€œå¤šå‰æ ‘â€æ–‡ä»¶ç³»ç»Ÿ<a hidden class=anchor aria-hidden=true href=#ç”¨-dentry-æ„å»ºå¤šå‰æ ‘æ–‡ä»¶ç³»ç»Ÿ>#</a></h3><ul><li><p>åœ¨ Linux å†…æ ¸ä¸­åªéœ€è¦ç”¨åˆ° <code>struct list_head d_child</code> å’Œ <code>struct list_head d_subdirs</code> è¿™ä¸¤ä¸ªä¸¤ä¸ªå…³é”®åŒå‘é“¾è¡¨å°±å¯ä»¥å®ç°ç›®å½•æ ‘ç»“æ„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>dentry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>......</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span> <span class=n>d_child</span><span class=p>;</span>	<span class=cm>/* child of parent list */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span> <span class=n>d_subdirs</span><span class=p>;</span>	<span class=cm>/* our children */</span>
</span></span><span class=line><span class=cl>	<span class=p>......</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>list_head</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>list_head</span> <span class=o>*</span><span class=n>next</span><span class=p>,</span> <span class=o>*</span><span class=n>prev</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><code>d_child</code></p><ul><li>è¡¨ç¤ºå½“å‰ç›®å½•é¡¹åœ¨çˆ¶ç›®å½•çš„å­é¡¹é“¾è¡¨ä¸­çš„ä½ç½®</li><li>å®ƒè¿æ¥åˆ°çˆ¶ç›®å½•çš„ <code>d_subdirs</code> é“¾è¡¨ï¼Œç”¨äºå½¢æˆç›®å½•æ ‘ä¸­çš„çˆ¶å­å…³ç³»</li><li><code>d_child -> prev</code> ä¸ºçˆ¶ç›®å½•æˆ–è€…å…„å¼Ÿ</li><li><code>d_child -> next</code> ä¸ºå…„å¼Ÿæˆ–è€… <code>NULL</code></li></ul></li><li><p><code>d_subdirs</code></p><ul><li>è¡¨ç¤ºå½“å‰ç›®å½•çš„å­ç›®å½•å’Œæ–‡ä»¶åˆ—è¡¨</li><li>ç”¨äºéå†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰å­é¡¹</li><li>å½“å‰ç›®å½•ä¸‹çš„æ¯ä¸ªå­é¡¹ï¼ˆæ–‡ä»¶æˆ–å­ç›®å½•ï¼‰çš„ <code>d_child</code> éƒ½ä¼šè¢«æŒ‚æ¥åˆ° <code>d_subdirs</code> é“¾è¡¨ä¸­</li><li><code>d_subdirs -> prev</code> ä¸º <code>NULL</code></li><li><code>d_subdirs -> next</code> ä¸ºå½“å‰ç›®å½•ä¸‹ç¬¬ä¸€ä¸ªå­©å­æˆ–è€… <code>NULL</code></li><li>åœ¨å½“å‰ç›®å½•æ–°å»ºæ–‡ä»¶æ—¶ï¼Œåˆ›å»ºçš„æ–‡ä»¶ä¼šä»¥å¤´æ’æ³•æ’åˆ° <code>d_subdirs -> next</code></li></ul></li><li><p><code>d_subdirs</code> ä¸ <code>d_child</code> é…åˆ</p><ul><li><code>d_subdirs</code> ç»´æŠ¤å­é¡¹åˆ—è¡¨ï¼Œ<code>d_child</code> é“¾æ¥åˆ°çˆ¶ç›®å½•çš„å­é¡¹é“¾è¡¨ï¼Œå½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„çš„ç›®å½•æ ‘</li></ul></li><li><p>å‡è®¾æ–‡ä»¶ç³»ç»Ÿç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>/
</span></span><span class=line><span class=cl>â”œâ”€â”€ home/
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ user/
</span></span><span class=line><span class=cl>â”‚   â”‚   â”œâ”€â”€ file1
</span></span><span class=line><span class=cl>â”‚   â”‚   â””â”€â”€ documents/
</span></span><span class=line><span class=cl>â””â”€â”€ etc/
</span></span></code></pre></td></tr></table></div></div></li><li><p>é‚£ä¹ˆå®ƒä»¬ä¹‹é—´çš„é“¾è¡¨å…³ç³»å›¾åº”è¯¥æ˜¯è¿™æ ·å­çš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>(root /) d_child
</span></span><span class=line><span class=cl>         d_subdirs
</span></span><span class=line><span class=cl>              +
</span></span><span class=line><span class=cl>              |
</span></span><span class=line><span class=cl>              +--&gt; (home) d_child
</span></span><span class=line><span class=cl>              |           d_subdirs
</span></span><span class=line><span class=cl>              |                +
</span></span><span class=line><span class=cl>              |                |
</span></span><span class=line><span class=cl>              |                +--&gt; (user) d_child
</span></span><span class=line><span class=cl>              |                            d_subdirs
</span></span><span class=line><span class=cl>              |                                 +
</span></span><span class=line><span class=cl>              |                                 |
</span></span><span class=line><span class=cl>              |                                 +--&gt; (file1) d_child
</span></span><span class=line><span class=cl>              |                                 |
</span></span><span class=line><span class=cl>              |                                 +--&gt; (documents) d_child
</span></span><span class=line><span class=cl>              |
</span></span><span class=line><span class=cl>              +--&gt; (etc) d_child
</span></span></code></pre></td></tr></table></div></div></li><li><p>ç°åœ¨è¿˜å‰©ä¸‹æœ€åä¸€ä¸ªé—®é¢˜ï¼Œ<code>d_subdirs</code> æ˜¯ <code>list_head</code> ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå®ƒæœ¬èº«åªåŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼š<code>next</code> å’Œ <code>prev</code>ï¼Œåº”è¯¥å¦‚ä½•é€šè¿‡ <code>list_head</code> æ‰¾åˆ°åŒ…å«å®ƒçš„ <code>struct dentry</code> å‘¢ï¼Ÿ</p></li><li><p>åœ¨å†…æ ¸é‡Œé¢ï¼Œå®ç°è¿™ä¸ªç›®æ ‡éœ€è¦ä¾èµ–åµŒå¥—ç»“æ„å’Œåç§»é‡è®¡ç®—</p></li><li><p>è€Œè¿™ä¸€æ­¥çš„å…³é”®å‡½æ•°æ˜¯ <code>contianer_of</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define container_of(ptr, type, member) \
</span></span></span><span class=line><span class=cl><span class=cp>  ((type *)((char *)(ptr) - offsetof(type, member)))
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>åœ¨ <code>dentry</code> è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œ<code>container_of</code> é‡Œé¢çš„å„ä¸ªå‚æ•°å¯ä»¥è¿™æ ·å­ç†è§£</p><ul><li><code>ptr</code> ï¼š<code>list_head</code> æŒ‡é’ˆï¼Œä¾‹å¦‚ <code>&amp;dir->d_subdirs</code></li><li><code>type</code>ï¼šåŒ…å« <code>list_head</code> çš„ç»“æ„ä½“ç±»å‹ï¼ˆè¿™é‡Œæ˜¯ <code>struct dentry</code>ï¼‰</li><li><code>member</code>ï¼š<code>list_head</code> å­—æ®µåœ¨ç»“æ„ä½“ä¸­çš„åå­—ï¼ˆè¿™é‡Œæ˜¯ <code>d_subdirs</code>ï¼‰</li><li><code>offsetof(type, member)</code>ï¼šè·å– <code>member</code> åœ¨ <code>type</code> ä¸­çš„åç§»é‡ï¼Œé€šè¿‡ <code>ptr</code> å‡å» <code>member</code> çš„åç§»é‡ï¼Œè®¡ç®—å‡ºç»“æ„ä½“çš„èµ·å§‹åœ°å€</li></ul></li></ul><h3 id=åˆ é™¤ç›®å½•>åˆ é™¤ç›®å½•<a hidden class=anchor aria-hidden=true href=#åˆ é™¤ç›®å½•>#</a></h3><ul><li>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œåˆ é™¤ä¸€ä¸ªç›®å½•æ—¶ï¼Œå†…æ ¸ä¼šä½¿ç”¨æ·±åº¦ä¼˜å…ˆç®—æ³•é€’å½’åœ°åˆ é™¤è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•</li></ul><h2 id=tmpfs-ä¸-shm-è”ç³»><code>tmpfs</code> ä¸ <code>shm</code> è”ç³»<a hidden class=anchor aria-hidden=true href=#tmpfs-ä¸-shm-è”ç³»>#</a></h2><h3 id=shm-introduction><code>shm</code> introduction<a hidden class=anchor aria-hidden=true href=#shm-introduction>#</a></h3><ul><li><code>shm</code> æ˜¯ Linux å†…æ ¸å†…éƒ¨å®ç°åŒ¿åå†…å­˜å…±äº«çš„æœºåˆ¶ï¼Œä¸»è¦ä¸ºå†…æ ¸æœåŠ¡ï¼Œä¸å¯¹ç”¨æˆ·ç›´æ¥å¯è§</li><li><code>shm</code> æœ€åˆè®¾è®¡æ˜¯ä¸ºæ”¯æŒ <code>POSIX</code> å…±äº«å†…å­˜ï¼ˆå¦‚ <code>shm_open</code>ï¼‰å’Œ System V å…±äº«å†…å­˜ï¼ˆå¦‚ <code>shmget</code>ï¼‰ï¼Œå…±äº«å†…å­˜éœ€è¦ä¸€ä¸ªä¸´æ—¶çš„ã€å†…å­˜é©»ç•™çš„æ–‡ä»¶ç³»ç»Ÿæ¥å­˜å‚¨å…±äº«çš„å†…å­˜é¡µ</li><li><code>shm</code> ä¸ºåŒ¿åé¡µé¢æä¾›ç»Ÿä¸€çš„æ–‡ä»¶æ”¯æŒæ¥å£ï¼Œä½¿å†…æ ¸å¯ä»¥ç”¨æ–‡ä»¶æ“ä½œå‡½æ•°ï¼ˆå¦‚ <code>readpage</code> æˆ– <code>writepage</code>ï¼‰ç®¡ç†è¿™äº›é¡µé¢ï¼Œå®ç°åŒ¿åå…±äº«å†…å­˜ï¼ˆå¦‚é€šè¿‡ <code>mmap</code> åˆ›å»ºçš„ <code>MAP_ANONYMOUS | MAP_SHARED</code> åŒºåŸŸï¼‰å’Œ System V å…±äº«å†…å­˜ï¼ˆ<code>shmget</code>ï¼‰</li><li><code>shm</code> å¯¹è™šæ‹Ÿæ–‡ä»¶çš„æè¿°éƒ½æ˜¯ä½¿ç”¨ <code>shmem_inode_info</code> ï¼ˆ <code>shmem_inode_info</code> å¯ä»¥çœ‹ä½œ <code>inode</code> çš„ç»§æ‰¿ï¼Œåœ¨å†…å­˜æ–‡ä»¶ç³»ç»Ÿé‡Œé¢å¦‚æœè¦åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œè¦å…ˆå‘ç³»ç»Ÿç”³è¯·ä¸€ä¸ª <code>inode</code> ï¼Œç„¶åæ‰æ˜¯å°†è¿™ä¸ª <code>inode</code> ä¼ ç»™ <code>shmem_inode_info</code> ï¼Œæœ‰ç‚¹ç±»ä¼¼ C++ é‡Œé¢çš„å½“ä¸€ä¸ªå­ç±»è¦å®ä¾‹åŒ–çš„æ—¶å€™éœ€è¦å…ˆå®ä¾‹åŒ–çˆ¶ç±»ï¼‰<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// https://elixir.bootlin.com/linux/v2.6.0/source/include/linux/shmem_fs.h#L10
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>shmem_inode_info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>spinlock_t</span>		<span class=n>lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>next_index</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>swp_entry_t</span>		<span class=n>i_direct</span><span class=p>[</span><span class=n>SHMEM_NR_DIRECT</span><span class=p>];</span> <span class=cm>/* for the first blocks */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>page</span>	       <span class=o>*</span><span class=n>i_indirect</span><span class=p>;</span> <span class=cm>/* indirect blocks */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>alloced</span><span class=p>;</span>    <span class=cm>/* data pages allocated to file */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>swapped</span><span class=p>;</span>    <span class=cm>/* subtotal assigned to swap */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span>		<span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>list_head</span>	<span class=n>list</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=nc>inode</span>		<span class=n>vfs_inode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=tmpfs-introduction><code>tmpfs</code> introduction<a hidden class=anchor aria-hidden=true href=#tmpfs-introduction>#</a></h3><ul><li><code>tmpfs</code> æ˜¯é¢å‘ç”¨æˆ·çš„ã€é€šç”¨çš„åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨ RAM ä½œä¸ºå­˜å‚¨åª’ä»‹ï¼Œç”¨äºæä¾›ä¸´æ—¶å­˜å‚¨å’Œå…±äº«å†…å­˜åŠŸèƒ½ï¼Œèƒ½å¤Ÿé€šè¿‡æŒ‚è½½ç‚¹æä¾›æ›´å¤šåŠŸèƒ½</li><li><code>tmpfs</code> çš„æ ¸å¿ƒå®ç°æ–‡ä»¶åœ¨å†…æ ¸çš„ <code>shm.c</code>ï¼Œ<code>tmpfs</code> çš„è®¸å¤šåŠŸèƒ½ï¼ŒåŒ…æ‹¬å†…å­˜é¡µçš„ç®¡ç†ã€<code>inode</code> çš„åˆ›å»ºå’Œæ“ä½œç­‰ï¼Œéƒ½åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®ç°</li></ul><h3 id=tmpfs-çš„æ ¸å¿ƒå®ç°æºè‡ªäº-shm><code>tmpfs</code> çš„æ ¸å¿ƒå®ç°æºè‡ªäº <code>shm</code><a hidden class=anchor aria-hidden=true href=#tmpfs-çš„æ ¸å¿ƒå®ç°æºè‡ªäº-shm>#</a></h3><ul><li><code>shm</code> åœ¨é€šå¸¸è¯­å¢ƒä¸‹ç¡®å®æ˜¯å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰çš„ç¼©å†™ï¼Œä½†åœ¨ Linux å†…æ ¸ä¸­ï¼Œ<code>shmem</code> æŒ‡çš„æ˜¯ä¸€ä¸ªæ›´é€šç”¨çš„æœºåˆ¶ï¼Œæ—¢ç”¨äºå…±äº«å†…å­˜ï¼Œä¹Ÿä¸º <code>tmpfs</code> æä¾›æ”¯æŒï¼Œè¿™æºäº Linux å†…æ ¸è®¾è®¡ä¸­å¯¹å†…å­˜ç®¡ç†çš„ç»Ÿä¸€æŠ½è±¡</li><li><code>shm</code> è¿™ä¸ªåå­—æ›´å¤šåæ˜ äº†å…¶å†å²èƒŒæ™¯ï¼Œç”±æœ€åˆæ”¯æŒå…±äº«å†…å­˜æœºåˆ¶çš„ä¸»è¦ç›®æ ‡ï¼Œåˆ°åæ¥é€æ¸æ‰©å±•åˆ°æ”¯æŒ <code>tmpfs</code></li><li>éšç€ <code>tmpfs</code> çš„å¼•å…¥ï¼ŒLinux ç›´æ¥å¤ç”¨äº† <code>shmem</code> çš„åŸºç¡€è®¾æ–½ï¼Œå› ä¸ºå®ƒä»¬çš„æ ¸å¿ƒéœ€æ±‚ä¸€è‡´ï¼šä¸€ç§æ— æŒä¹…å­˜å‚¨åç«¯ã€åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿ</li><li>å› æ­¤ <code>shm</code> è¿™ç§å‘½åå¹¶ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„â€œå…±äº«å†…å­˜â€é™å®šï¼Œè€Œæ˜¯ä¸€ä¸ªå†å²é—ç•™çš„åå­—</li><li>å½“ä½¿ç”¨ <code>tmpfs</code> æˆ–å…±äº«å†…å­˜æ—¶ï¼Œå†…æ ¸å®é™…ä¸Šéƒ½åœ¨è°ƒç”¨ <code>shmem</code> ç›¸å…³çš„åŠŸèƒ½ï¼Œæ¢å¥è¯è¯´ï¼Œ<code>tmpfs</code> å’Œå…±äº«å†…å­˜æ˜¯åŒä¸€ä¸ªæœºåˆ¶åœ¨ä¸åŒåœºæ™¯ä¸‹çš„ä¸¤ä¸ªåº”ç”¨å®ä¾‹</li><li><code>shmem</code> å’Œ <code>tmpfs</code> æ ¸å¿ƒéœ€æ±‚ä¸€è‡´ï¼š<ul><li>åŠ¨æ€åˆ†é…é¡µï¼ˆåœ¨éœ€è¦æ—¶ä¸ºæ–‡ä»¶æˆ–å…±äº«å†…å­˜æ®µåˆ†é…å†…å­˜é¡µï¼‰</li><li>æ”¯æŒæŒ‰éœ€å¢é•¿ï¼ˆ<code>tmpfs</code> æ–‡ä»¶æˆ–å…±äº«å†…å­˜æ®µä¼šéšå†…å®¹å¢é•¿ï¼‰</li><li>å†…å­˜é¡µé¢å¯ä»¥è¢«å›æ”¶æˆ–å†™å…¥äº¤æ¢åˆ†åŒºï¼ˆswappingï¼‰</li></ul></li><li><code>shmem</code> æ˜¯åº•å±‚æœºåˆ¶ï¼Œæœ€åˆæœåŠ¡äºå…±äº«å†…å­˜éœ€æ±‚</li><li><code>tmpfs</code> æ˜¯åŸºäº <code>shmem</code> çš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œæ‰©å±•äº†å…¶ä½¿ç”¨åœºæ™¯ï¼Œæ”¯æŒä¸´æ—¶æ–‡ä»¶å­˜å‚¨</li><li><code>tmpfs</code> çš„è¯ç”Ÿå¾—ç›Šäº <code>shmem</code> çš„å­˜åœ¨ï¼Œæ˜¯å…±äº«å†…å­˜æŠ€æœ¯çš„ä¸€æ¬¡æˆåŠŸå¤ç”¨</li></ul><h2 id=shm-ä½¿ç”¨><code>shm</code> ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#shm-ä½¿ç”¨>#</a></h2><ul><li><p>System V å…±äº«å†…å­˜</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// ä½¿ç”¨ `shmget` å’Œ `shmat` åˆ›å»ºçš„å…±äº«å†…å­˜æ®µï¼Œé€šè¿‡ `shm` æä¾›åº•å±‚æ”¯æŒ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>shmid</span> <span class=o>=</span> <span class=nf>shmget</span><span class=p>(</span><span class=n>IPC_PRIVATE</span><span class=p>,</span> <span class=mi>1024</span><span class=p>,</span> <span class=n>IPC_CREAT</span> <span class=o>|</span> <span class=mo>0666</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>data</span> <span class=o>=</span> <span class=nf>shmat</span><span class=p>(</span><span class=n>shmid</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>strcpy</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=s>&#34;Hello, shm!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Data in shared memory: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>data</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>åŒ¿åå…±äº«å†…å­˜</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// å½“è¿›ç¨‹è°ƒç”¨ `mmap` å¹¶æŒ‡å®š `MAP_ANONYMOUS | MAP_SHARED` æ—¶ï¼Œ`shm` ä¼šä¸ºè¿™äº›åŒ¿åé¡µé¢åˆ›å»ºæ”¯æŒ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>size_t</span> <span class=n>size</span> <span class=o>=</span> <span class=mi>4096</span><span class=p>;</span>  <span class=c1>// åˆ†é…ä¸€ä¸ª4KBçš„å†…å­˜åŒºåŸŸ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=o>*</span><span class=n>addr</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_SHARED</span> <span class=o>|</span> <span class=n>MAP_ANONYMOUS</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>addr</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;mmap failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// é€šè¿‡æŒ‡é’ˆè®¿é—®å¹¶ä¿®æ”¹åŒ¿åå…±äº«å†…å­˜
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=o>*</span><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=p>)</span><span class=n>addr</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>ä½¿ç”¨ <code>POSIX</code> æ–‡ä»¶æ¥å£ä¸ <code>shm</code> ç»“åˆ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>shm_name</span> <span class=o>=</span> <span class=s>&#34;/my_shm&#34;</span><span class=p>;</span>  <span class=c1>// å…±äº«å†…å­˜å¯¹è±¡çš„åç§°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>size_t</span> <span class=n>size</span> <span class=o>=</span> <span class=mi>4096</span><span class=p>;</span>                <span class=c1>// å…±äº«å†…å­˜çš„å¤§å°
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// åˆ›å»ºæˆ–æ‰“å¼€å…±äº«å†…å­˜å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1>// ä½¿ç”¨ shm_open() åˆ›å»ºæˆ–æ‰“å¼€å…±äº«å†…å­˜å¯¹è±¡åï¼Œè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥é€šè¿‡ open() è¿›è¡Œè®¿é—®
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>shm_fd</span> <span class=o>=</span> <span class=nf>shm_open</span><span class=p>(</span><span class=n>shm_name</span><span class=p>,</span> <span class=n>O_CREAT</span> <span class=o>|</span> <span class=n>O_RDWR</span><span class=p>,</span> <span class=n>S_IRUSR</span> <span class=o>|</span> <span class=n>S_IWUSR</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>shm_fd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;shm_open&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// è®¾ç½®å…±äº«å†…å­˜çš„å¤§å°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nf>ftruncate</span><span class=p>(</span><span class=n>shm_fd</span><span class=p>,</span> <span class=n>size</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;ftruncate&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å°†å…±äº«å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=o>*</span><span class=n>shm_ptr</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_SHARED</span><span class=p>,</span> <span class=n>shm_fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>shm_ptr</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;mmap&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ä½¿ç”¨å…±äº«å†…å­˜
</span></span></span><span class=line><span class=cl><span class=c1>// å†™å…¥æ•°æ®åˆ°å…±äº«å†…å­˜
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>snprintf</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>shm_ptr</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=s>&#34;Hello from shared memory!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// è§£é™¤æ˜ å°„
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nf>munmap</span><span class=p>(</span><span class=n>shm_ptr</span><span class=p>,</span> <span class=n>size</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;munmap&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å…³é—­å…±äº«å†…å­˜å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>close</span><span class=p>(</span><span class=n>shm_fd</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=tmpfs-ä½¿ç”¨><code>tmpfs</code> ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#tmpfs-ä½¿ç”¨>#</a></h2><ul><li><code>tmpfs</code> é»˜è®¤æŒ‚è½½åˆ° <code>/tmp</code>ï¼Œä¸ºç”¨æˆ·æä¾›å¿«é€Ÿçš„ã€åŸºäº RAM çš„ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ç©ºé—´ï¼Œè¯»å†™é€Ÿåº¦å¿«ï¼Œå®ƒä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‚è½½åˆ°å…¶ä»–åœ°æ–¹<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># åœ¨ /mnt/tmpfs æŒ‚è½½ä¸€ä¸ª tmpfs æ–‡ä»¶ç³»ç»Ÿ</span>
</span></span><span class=line><span class=cl>sudo mount -t tmpfs -o <span class=nv>size</span><span class=o>=</span>128M tmpfs /mnt/tmpfs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åœ¨ tmpfs ä¸Šåˆ›å»ºæ–‡ä»¶</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Hello, tmpfs!&#34;</span> &gt; /mnt/tmpfs/testfile
</span></span><span class=line><span class=cl>cat /mnt/tmpfs/testfile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¸è½½ tmpfs</span>
</span></span><span class=line><span class=cl>sudo umount /mnt/tmpfs
</span></span></code></pre></td></tr></table></div></div></li><li><code>tmpfs</code> ä¹Ÿå¯ä»¥ä½¿ç”¨å¤šè¿›ç¨‹ <code>open</code> æˆ–è€…å¤šè¿›ç¨‹ <code>mmap</code> åˆ°ä¸€ä¸ªå…±åŒçš„ <code>tmpfs</code> æ–‡ä»¶è¾¾åˆ°è¿›ç¨‹é—´é€šä¿¡çš„æ•ˆæœ<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;example.txt&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>mapped</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=mi>4096</span><span class=p>,</span> <span class=n>PROT_READ</span><span class=p>,</span> <span class=n>MAP_PRIVATE</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=è§‚å¯ŸçœŸå®æœºå™¨ä¸Šçš„-tmpfs>è§‚å¯ŸçœŸå®æœºå™¨ä¸Šçš„ <code>tmpfs</code><a hidden class=anchor aria-hidden=true href=#è§‚å¯ŸçœŸå®æœºå™¨ä¸Šçš„-tmpfs>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hcy@debian:~$ df -h
</span></span><span class=line><span class=cl>æ–‡ä»¶ç³»ç»Ÿ        å¤§å°  å·²ç”¨  å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹
</span></span><span class=line><span class=cl>udev             32G     <span class=m>0</span>   32G    0% /dev
</span></span><span class=line><span class=cl>tmpfs           6.3G  1.9M  6.3G    1% /run
</span></span><span class=line><span class=cl>/dev/sdb1       119G   29G   91G   25% /
</span></span><span class=line><span class=cl>tmpfs            32G  550M   31G    2% /dev/shm
</span></span><span class=line><span class=cl>tmpfs           5.0M   12K  5.0M    1% /run/lock
</span></span><span class=line><span class=cl>tmpfs            32G   96M   32G    1% /tmp
</span></span><span class=line><span class=cl>/dev/sdb2       300M  5.9M  294M    2% /boot/efi
</span></span><span class=line><span class=cl>/dev/sda2       900G  218G  682G   25% /mnt/146bf4b9-b9ad-486d-811c-dcbb31aa3324
</span></span><span class=line><span class=cl>tmpfs           6.3G  256K  6.3G    1% /run/user/1000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>hcy@debian:~$ id hcy
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1000<span class=o>(</span>hcy<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1000<span class=o>(</span>hcy<span class=o>)</span> <span class=nv>ç»„</span><span class=o>=</span>1000<span class=o>(</span>hcy<span class=o>)</span>, ...
</span></span></code></pre></td></tr></table></div></div><ul><li>åœ¨ä¸Šé¢çš„ <code>df -h</code> è¾“å‡ºä¸­ï¼Œåˆ—å‡ºäº†å¤šä¸ª <code>tmpfs</code> æŒ‚è½½ç‚¹<ul><li><p><code>/run</code>: <code>tmpfs</code> è¢«æŒ‚è½½åœ¨ <code>/run</code> ç›®å½•ã€‚å®ƒæ˜¯ä¸€ä¸ªåŠ¨æ€çš„ã€çŸ­æœŸçš„æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨ç³»ç»Ÿè¿è¡Œæ—¶çš„æ•°æ®ï¼ˆå¦‚è¿›ç¨‹ ID æ–‡ä»¶ã€é”æ–‡ä»¶ç­‰ï¼‰</p></li><li><p><code>/dev/shm</code>: <code>tmpfs</code> è¢«æŒ‚è½½åœ¨ <code>/dev/shm</code> ç›®å½•ï¼Œå®ƒæ˜¯å…±äº«å†…å­˜çš„æŒ‚è½½ç‚¹ï¼Œä¾›è¿›ç¨‹é—´é€šä¿¡ä½¿ç”¨</p></li><li><p><code>/run/lock</code>: <code>tmpfs</code> è¢«æŒ‚è½½åœ¨ <code>/run/lock</code> ç›®å½•ï¼Œç”¨äºå­˜æ”¾è¿›ç¨‹é—´é”æ–‡ä»¶</p></li><li><p><code>/tmp</code>: <code>tmpfs</code> è¢«æŒ‚è½½åœ¨ <code>/tmp</code> ç›®å½•ï¼Œç”¨äºå­˜æ”¾ä¸´æ—¶æ–‡ä»¶</p></li><li><p><code>/run/user/1000</code>: è¯¥ <code>tmpfs</code> æ˜¯ä¸ºç”¨æˆ· ID ä¸º 1000 çš„ç”¨æˆ·ï¼ˆä¹Ÿå°±æ˜¯ç”¨æˆ· <code>hcy</code> ï¼‰æä¾›çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚ç¨‹åºç¼“å­˜ã€ä¸´æ—¶æ–‡ä»¶ç­‰</p></li></ul></li><li>è¿™äº› <code>tmpfs</code> æŒ‚è½½ç‚¹çš„æ•°æ®åœ¨æœºå™¨é‡å¯ä¹‹åéƒ½ä¸ä¼šå­˜åœ¨</li></ul><h3 id=è§‚å¯Ÿå®¹å™¨é‡Œé¢çš„-tmpfs>è§‚å¯Ÿå®¹å™¨é‡Œé¢çš„ <code>tmpfs</code><a hidden class=anchor aria-hidden=true href=#è§‚å¯Ÿå®¹å™¨é‡Œé¢çš„-tmpfs>#</a></h3><ul><li>åœ¨ <code>Docker</code> ä¸­ï¼Œå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯åŸºäº <code>UnionFS</code>ï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰çš„ï¼Œé€šå¸¸é‡‡ç”¨çš„æ˜¯ <code>aufs</code>ã€<code>overlay</code> æˆ– <code>overlay2</code> ç­‰æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œ<code>UnionFS</code> å¹¶ä¸ç›´æ¥ä½¿ç”¨ <code>tmpfs</code>ï¼Œé™¤éæ˜ç¡®å°†æŸäº›ç›®å½•æŒ‚è½½ä¸º <code>tmpfs</code></li><li>Docker å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯æŒä¹…åŒ–çš„ï¼Œåœ¨å®¹å™¨ä¸­æ–‡ä»¶å­˜å‚¨åœ¨é•œåƒå±‚ <code>read-only layer</code> å’Œå®¹å™¨å±‚ <code>read-write layer</code> ä¸Š</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å®¹å™¨é‡å¯æ—¶ï¼Œå®¹å™¨å±‚ä¼šä¿æŒä¸å˜ï¼Œå³ä½¿å†™å…¥åˆ° <code>/tmp</code> ç›®å½•çš„æ–‡ä»¶ï¼Œéƒ½ä¼šä¿å­˜åœ¨å®¹å™¨å±‚ä¸­ï¼Œè€Œä¸æ˜¯ä¸¢å¤±</li><li>åªæœ‰åœ¨å®¿ä¸»æœºå±‚é¢åœ¨å®¹å™¨åˆ›å»ºæ—¶ï¼Œé€šè¿‡ <code>--tmpfs</code> å‚æ•°æ¥æŒ‡å®šå°† <code>/tmp</code> æŒ‚è½½ä¸º tmpfsï¼Œæ‰æœ‰å¯èƒ½è®©å®¹å™¨é‡Œé¢çš„ <code>/tmp</code> çš„è¡¨ç°å’Œå¸¸è§„çš„ä¸€æ ·<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --tmpfs /tmp &lt;image_id&gt;
</span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=å…¨å±€å…±äº«çš„é›¶é¡µglobal-zero-page>å…¨å±€å…±äº«çš„é›¶é¡µï¼ˆglobal zero pageï¼‰<a hidden class=anchor aria-hidden=true href=#å…¨å±€å…±äº«çš„é›¶é¡µglobal-zero-page>#</a></h2><ul><li>Linux å†…æ ¸ä¸­æœ‰ä¸€ä¸ªå…¨å±€å…±äº«çš„é›¶é¡µï¼Œæ‰€æœ‰å­—èŠ‚éƒ½è¢«åˆå§‹åŒ–ä¸ºé›¶ï¼Œè¿™å—å†…å­˜é¡µè¢«å…¨å±€æ‰€æœ‰è¿›ç¨‹å…±äº«ï¼Œé€šå¸¸æ˜¯åªè¯»çš„ï¼Œå¤šè¿›ç¨‹å¯ä»¥åŒæ—¶è®¿é—®</li><li>å½“ä¸€ä¸ªè¿›ç¨‹éœ€è¦è®¿é—®å¤§é‡çš„å…¨é›¶æ•°æ®ï¼ˆå¦‚æœªåˆå§‹åŒ–çš„å†…å­˜ã€æ‰©å±•æ–‡ä»¶çš„ç©ºç™½éƒ¨åˆ†ï¼‰ï¼Œå¯ä»¥ç›´æ¥æ˜ å°„åˆ°å…¨å±€é›¶é¡µï¼Œè€Œæ— éœ€å®é™…åˆ†é…å’Œåˆå§‹åŒ–ç‰©ç†å†…å­˜ï¼Œé¿å…ä¸ºæ¯ä¸ªè¿›ç¨‹å•ç‹¬åˆ†é…ä¸€å—å…¨é›¶çš„å†…å­˜é¡µ</li><li>ä¾‹å¦‚å½“æ–‡ä»¶é€šè¿‡ <code>truncate()</code> æ‰©å±•æ—¶ï¼Œæ–°å¢åŠ çš„éƒ¨åˆ†éœ€è¦åˆå§‹åŒ–ä¸ºé›¶ã€‚å¦‚æœç›´æ¥å†™é›¶åˆ°ç£ç›˜æˆ–å†…å­˜ï¼Œä¼šæ¶ˆè€—èµ„æº</li><li>é€šè¿‡å…¨å±€é›¶é¡µï¼Œæ–‡ä»¶ç³»ç»Ÿå¯ä»¥å°†æ–°å¢åŠ çš„éƒ¨åˆ†æ˜ å°„åˆ°è¿™å—é›¶é¡µï¼Œè€Œä¸éœ€è¦å®é™…åˆ†é…å’Œåˆå§‹åŒ–</li><li>åˆä¾‹å¦‚è¿›ç¨‹åˆ†é…å†…å­˜æ—¶ï¼Œæœªä½¿ç”¨çš„éƒ¨åˆ†ï¼ˆä¾‹å¦‚é€šè¿‡ <code>mmap</code> æ˜ å°„çš„åŒ¿åå†…å­˜ï¼‰é€šå¸¸è¢«æ˜ å°„ä¸ºé›¶é¡µï¼Œç›´åˆ°å®é™…å†™å…¥æ•°æ®ä¸ºæ­¢</li><li>ç”±äºé›¶é¡µæ˜¯åªè¯»çš„ï¼Œå¦‚æœè¿›ç¨‹è¯•å›¾å†™å…¥é›¶é¡µï¼Œä¼šè§¦å‘é¡µé”™è¯¯ <code>page fault</code>ï¼Œå†…æ ¸ä¼šå¤åˆ¶ä¸€å—æ–°çš„ç‰©ç†é¡µä¾›è¿›ç¨‹ä½¿ç”¨ï¼Œè¿™å«åšâ€œå†™æ—¶å¤åˆ¶â€ <code>Copy-on-Write, COW</code></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://hcy-asleep.github.io/Linux%E7%A3%81%E7%9B%98%E5%8D%A0%E7%94%A8%E5%88%86%E6%9E%90/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>Linuxç£ç›˜å ç”¨åˆ†æ</span></a></nav></footer></br></br><script src=https://giscus.app/client.js data-repo=HCY-ASLEEP/HCY-ASLEEP.github.io data-repo-id=R_kgDOISFjNg data-category=Announcements data-category-id=DIC_kwDOISFjNs4CUJyb data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://hcy-asleep.github.io/>Memos</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>